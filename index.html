<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sales Dashboard - Data Management</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --bg: #ffffff;
      --card: #f8fafb;
      --text: #1a202c;
      --muted: #718096;
      --border: #e2e8f0;
      --accent-1: #bee3f8;
      --accent-2: #fbd38d;
      --accent-3: #c6f6d5;
      --accent-4: #fbb6ce;
      --accent-5: #e9d8fd;
      --glass: rgba(26, 32, 44, 0.05);
      --primary: #4299e1;
      --success: #48bb78;
      --danger: #f56565;
      --warning: #ed8936;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: Inter, system-ui, sans-serif;
      line-height: 1.6;
    }

    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
    h1 { font-size: 24px; font-weight: 600; margin: 0; }
    .subtitle { font-size: 14px; color: var(--muted); }
    .controls { display: flex; gap: 12px; flex-wrap: wrap; }
    button, select { padding: 8px 16px; border-radius: 8px; border: 1px solid var(--border); background: white; cursor: pointer; font-size: 14px; transition: all 0.2s; }
    button:hover { transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .btn-primary { background: var(--primary); color: white; border: none; }
    .btn-success { background: var(--success); color: white; border: none; }
    .btn-danger { background: var(--danger); color: white; border: none; }
    .btn-sm { padding: 6px 12px; font-size: 12px; }

    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 20px; }
    .card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: all 0.3s; }
    .card:hover { box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .kpi { grid-column: span 3; }
    .wide { grid-column: span 6; }
    .full { grid-column: span 12; }
    .kpi h3 { margin: 0 0 8px 0; font-size: 14px; font-weight: 500; color: var(--muted); }
    .kpi .value { font-size: 28px; font-weight: 600; margin-bottom: 4px; }
    .trend { font-size: 14px; display: flex; align-items: center; gap: 4px; }
    .positive { color: var(--success); }
    .negative { color: var(--danger); }
    .neutral { color: var(--muted); }

    .chart-container { position: relative; height: 300px; margin-top: 16px; }
    .tabs { display: flex; gap: 4px; margin-bottom: 16px; border-bottom: 1px solid var(--border); }
    .tab { padding: 10px 16px; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
    .tab:hover { background: var(--glass); }
    .tab.active { border-bottom-color: var(--primary); color: var(--primary); font-weight: 500; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 14px; }
    .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .data-table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    .data-table th, .data-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); }
    .data-table th { background: var(--glass); font-weight: 500; }
    .data-table tr:hover { background: var(--glass); }
    .action-btn { padding: 6px 10px; margin: 0 4px; font-size: 12px; }

    .filter-chips { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
    .chip { background: var(--glass); padding: 6px 12px; border-radius: 16px; font-size: 13px; display: flex; align-items: center; gap: 6px; cursor: pointer; transition: all 0.2s; }
    .chip:hover { background: var(--accent-1); }
    .chip.active { background: var(--primary); color: white; }
    .chip .remove { cursor: pointer; font-size: 12px; }

    .summary-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; margin-top: 16px; }
    .summary-card { background: white; padding: 16px; border-radius: 8px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .summary-card .label { font-size: 12px; color: var(--muted); margin-bottom: 8px; }
    .summary-card .value { font-size: 20px; font-weight: 600; }
    .footer { margin-top: 32px; text-align: center; color: var(--muted); font-size: 14px; padding: 16px 0; border-top: 1px solid var(--border); }

    .report-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
    .report-table th, .report-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); }
    .report-table th { background: var(--glass); font-weight: 600; font-size: 14px; }
    .report-table tr:hover { background: var(--glass); }
    .report-section { margin-bottom: 30px; }
    .report-section h3 { margin: 0 0 16px 0; color: var(--text); font-size: 18px; }
    .growth-positive { color: var(--success); font-weight: 600; }
    .growth-negative { color: var(--danger); font-weight: 600; }
    .export-btn { margin-bottom: 20px; }

    .data-preview { max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 10px; margin-top: 10px; }
    .data-preview table { font-size: 12px; }
    .data-preview th, .data-preview td { padding: 6px; }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 1000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.success {
      border-left: 4px solid var(--success);
    }
    
    .notification.error {
      border-left: 4px solid var(--danger);
    }
    
    .notification.info {
      border-left: 4px solid var(--primary);
    }

    @media (max-width: 900px) {
      .kpi { grid-column: span 6; }
      .wide { grid-column: span 12; }
      .form-row { grid-template-columns: 1fr; }
      .report-table { font-size: 12px; }
      .report-table th, .report-table td { padding: 8px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Sales Performance Dashboard</h1>
        <div class="subtitle">Data Management â€¢ Light Mode â€¢ Interactive</div>
      </div>
      <div class="controls">
        <button id="saveBtn" class="btn-primary"><i class="fas fa-save"></i> Save Data</button>
        <button id="exportBtn"><i class="fas fa-download"></i> Export CSV</button>
        <button id="importBtn"><i class="fas fa-upload"></i> Import Data</button>
      </div>
    </header>

    <div class="tabs">
      <div class="tab active" data-tab="dashboard">Dashboard</div>
      <div class="tab" data-tab="branches">Branches</div>
      <div class="tab" data-tab="channels">Channels</div>
      <div class="tab" data-tab="data">Raw Data</div>
      <div class="tab" data-tab="report">Report</div>
    </div>

    <!-- Dashboard Tab -->
    <div class="tab-content active" id="dashboard-tab">
      <div class="grid">
        <div class="card kpi">
          <h3>Total Sales 2024</h3>
          <div class="value" id="total2024">$42,040,566</div>
          <div class="trend neutral">All branches combined</div>
        </div>
        
        <div class="card kpi">
          <h3>Total Sales 2025</h3>
          <div class="value" id="total2025">$38,336,806</div>
          <div class="trend negative">
            <span>â†“ 8.8%</span> vs 2024
          </div>
        </div>
        
        <div class="card kpi">
          <h3>Top Growing Branch</h3>
          <div class="value" id="topBranch">ELctria</div>
          <div class="trend positive">
            <span>â†‘ 79.4%</span> growth
          </div>
        </div>

        <div class="card wide">
          <h3 style="margin:0 0 16px 0">Branch Performance Comparison</h3>
          <div class="chart-container">
            <canvas id="branchChart"></canvas>
          </div>
        </div>

        <div class="card wide">
          <h3 style="margin:0 0 16px 0">Monthly Sales Trend (Jan-Oct)</h3>
          <div class="chart-container">
            <canvas id="monthlyChart"></canvas>
          </div>
        </div>

        <div class="card full">
          <h3 style="margin:0 0 16px 0">Channel Performance Analysis</h3>
          <div class="filter-chips" id="channelFilters">
            <div class="chip active" data-channel="all">
              <i class="fas fa-check"></i> All Channels
            </div>
            <div class="chip" data-channel="Careem">Careem</div>
            <div class="chip" data-channel="Noon">Noon</div>
            <div class="chip" data-channel="Keeta">Keeta</div>
            <div class="chip" data-channel="Other">Other</div>
            <div class="chip" data-channel="Smile">Smile</div>
            <div class="chip" data-channel="Selif Delivery">Selif Delivery</div>
            <div class="chip" data-channel="Online Wab">Online Wab</div>
            <div class="chip" data-channel="Talabat">Talabat</div>
            <div class="chip" data-channel="Deliveroo">Deliveroo</div>
          </div>
          <div class="chart-container">
            <canvas id="channelChart"></canvas>
          </div>
        </div>

        <div class="card wide">
          <h3>Branch Performance Summary</h3>
          <div class="summary-grid">
            <div class="summary-card">
              <div class="label">Best Performer</div>
              <div class="value" style="color: var(--success);">ELctria</div>
            </div>
            <div class="summary-card">
              <div class="label">Biggest Growth</div>
              <div class="value" style="color: var(--success);">+79.4%</div>
            </div>
            <div class="summary-card">
              <div class="label">Biggest Decline</div>
              <div class="value" style="color: var(--danger);">Hamdan St</div>
            </div>
            <div class="summary-card">
              <div class="label">Decline %</div>
              <div class="value" style="color: var(--danger);">-25.9%</div>
            </div>
          </div>
        </div>

        <div class="card wide">
          <h3>Key Insights & Recommendations</h3>
          <ul style="padding-left: 20px; margin-top: 12px;">
            <li><strong>Focus on Growth Channels:</strong> Careem shows exceptional growth (+270.9%) across branches</li>
            <li><strong>Emerging Opportunities:</strong> ELctria branch shows 79.4% growth - consider expansion</li>
            <li><strong>Address Declines:</strong> Hamdan St (-25.9%) and Khalidiya (-20.1%) need strategic review</li>
            <li><strong>Channel Optimization:</strong> Revitalize Deliveroo and Talabat with targeted promotions</li>
            <li><strong>Data Note:</strong> 2025 data includes Jan-Oct only - full year comparison pending Nov-Dec</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Branches Tab -->
    <div class="tab-content" id="branches-tab">
      <div class="card full">
        <h3 style="margin:0 0 16px 0">Branch Management</h3>
        <div class="form-row">
          <div class="form-group">
            <label for="branchName">Branch Name</label>
            <input type="text" id="branchName" placeholder="Enter branch name">
          </div>
          <div class="form-group">
            <label for="branchLocation">Location</label>
            <input type="text" id="branchLocation" placeholder="Enter location">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="branchManager">Manager</label>
            <input type="text" id="branchManager" placeholder="Enter manager name">
          </div>
          <div class="form-group">
            <label for="branchStatus">Status</label>
            <select id="branchStatus">
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
              <option value="opening">Opening Soon</option>
            </select>
          </div>
        </div>
        <button id="addBranchBtn" class="btn-success"><i class="fas fa-plus"></i> Add Branch</button>
        
        <table class="data-table">
          <thead>
            <tr>
              <th>Branch Name</th>
              <th>Location</th>
              <th>Manager</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="branchesTableBody">
            <!-- Branches will be populated here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Channels Tab -->
    <div class="tab-content" id="channels-tab">
      <div class="card full">
        <h3 style="margin:0 0 16px 0">Channel Management</h3>
        <div class="form-row">
          <div class="form-group">
            <label for="channelName">Channel Name</label>
            <input type="text" id="channelName" placeholder="Enter channel name">
          </div>
          <div class="form-group">
            <label for="channelType">Channel Type</label>
            <select id="channelType">
              <option value="delivery">Delivery</option>
              <option value="online">Online</option>
              <option value="app">App</option>
              <option value="other">Other</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="channelCommission">Commission (%)</label>
            <input type="number" id="channelCommission" placeholder="Enter commission rate" min="0" max="100">
          </div>
          <div class="form-group">
            <label for="channelStatus">Status</label>
            <select id="channelStatus">
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
              <option value="pending">Pending</option>
            </select>
          </div>
        </div>
        <button id="addChannelBtn" class="btn-success"><i class="fas fa-plus"></i> Add Channel</button>
        
        <table class="data-table">
          <thead>
            <tr>
              <th>Channel Name</th>
              <th>Type</th>
              <th>Commission</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="channelsTableBody">
            <!-- Channels will be populated here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Raw Data Tab -->
    <div class="tab-content" id="data-tab">
      <div class="card full">
        <h3 style="margin:0 0 16px 0">Raw Sales Data</h3>
        <div class="form-group">
          <label for="rawData">JSON Data</label>
          <textarea id="rawData" rows="20" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-family: monospace;"></textarea>
        </div>
        <button id="updateDataBtn" class="btn-primary"><i class="fas fa-sync"></i> Update Data</button>
        <button id="resetDataBtn" class="btn-danger"><i class="fas fa-undo"></i> Reset to Default</button>
        
        <div style="margin-top: 20px;">
          <h4 style="margin: 0 0 10px 0;">Parse Raw Data String</h4>
          <p style="font-size: 14px; color: var(--muted); margin-bottom: 10px;">
            Paste your raw data string below to parse and integrate into the dashboard
          </p>
          <textarea id="rawDataString" rows="10" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-family: monospace; margin-bottom: 10px;"></textarea>
          <button id="parseAndIntegrateBtn" class="btn-primary"><i class="fas fa-sync"></i> Parse and Integrate Raw Data</button>
          
          <div id="dataPreview" class="data-preview" style="display: none;">
            <h4 style="margin: 0 0 10px 0;">Data Preview</h4>
            <table id="previewTable">
              <thead>
                <tr>
                  <th>Branch</th>
                  <th>Month</th>
                  <th>Year</th>
                  <th>Total Sales</th>
                  <th>Channels</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Report Tab -->
    <div class="tab-content" id="report-tab">
      <div class="card full">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="margin:0;">Sales Performance Report</h3>
          <button id="exportReportBtn" class="btn-primary"><i class="fas fa-file-csv"></i> Export Report</button>
        </div>

        <!-- Branch Performance Summary -->
        <div class="report-section">
          <h3>Branch Performance Summary</h3>
          <table class="report-table">
            <thead>
              <tr>
                <th>Branch</th>
                <th>2025 Total</th>
                <th>2024 Total</th>
                <th>Difference</th>
                <th>Growth %</th>
              </tr>
            </thead>
            <tbody id="branchReportBody">
              <!-- Report data will be populated here -->
            </tbody>
          </table>
        </div>

        <!-- Channel Performance Overview -->
        <div class="report-section">
          <h3>Channel Performance Overview</h3>
          <table class="report-table">
            <thead>
              <tr>
                <th>Channel</th>
                <th>2025</th>
                <th>2024</th>
                <th>Difference</th>
                <th>% Growth</th>
              </tr>
            </thead>
            <tbody id="channelReportBody">
              <!-- Report data will be populated here -->
            </tbody>
          </table>
        </div>

        <!-- Monthly Trend Analysis -->
        <div class="report-section">
          <h3>Monthly Trend Analysis (2024 vs 2025)</h3>
          <table class="report-table">
            <thead>
              <tr>
                <th>Month</th>
                <th>2024</th>
                <th>2025</th>
                <th>Change</th>
                <th>Trend</th>
              </tr>
            </thead>
            <tbody id="monthlyReportBody">
              <!-- Report data will be populated here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="footer">
      Sales Dashboard â€¢ Data Management â€¢ Light Mode â€¢ 
      <span id="dataStatus">Data saved locally</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Data Management System
    class SalesDataManager {
      constructor() {
        this.data = this.loadDefaultData();
        this.branches = [];
        this.channels = [];
        this.salesData = {};
        this.rawDataString = ''; // Store the raw data string
        this.parsedData = []; // Store parsed raw data
        this.rawDataChannels = []; // Store unique channels from raw data
        this.rawDataBranches = []; // Store unique branches from raw data
        this.monthlyData = { 2024: {}, 2025: {} }; // Store monthly data
        this.init();
      }

      init() {
        this.loadData();
        this.setupEventListeners();
        this.renderDashboard();
        this.renderBranches();
        this.renderChannels();
        this.renderRawData();
        this.renderReports();
      }

      loadDefaultData() {
        return {
          branches: [
            { id: 1, name: 'Hamdan St', location: 'Downtown', manager: 'Ahmed Hassan', status: 'active' },
            { id: 2, name: 'Khalidiya', location: 'Khalidiya', manager: 'Fatima Ali', status: 'active' },
            { id: 3, name: 'Shabiya 11', location: 'Shabiya', manager: 'Omar Khalid', status: 'active' },
            { id: 4, name: 'Muroor', location: 'Muroor', manager: 'Sara Ahmed', status: 'active' },
            { id: 5, name: 'Barsha', location: 'Barsha', manager: 'Yousuf Mohammed', status: 'active' },
            { id: 6, name: 'Satwa', location: 'Satwa', manager: 'Layla Hassan', status: 'active' },
            { id: 7, name: 'ELctria', location: 'Electra', manager: 'Kareem Ali', status: 'active' },
            { id: 8, name: 'Rigga', location: 'Rigga', manager: 'Nora Ahmed', status: 'opening' }
          ],
          channels: [
            { id: 1, name: 'Selif Delivery', type: 'delivery', commission: 15, status: 'active' },
            { id: 2, name: 'Online Wab', type: 'online', commission: 10, status: 'active' },
            { id: 3, name: 'Noon', type: 'online', commission: 12, status: 'active' },
            { id: 4, name: 'Careem', type: 'app', commission: 20, status: 'active' },
            { id: 5, name: 'Smile', type: 'app', commission: 18, status: 'active' },
            { id: 6, name: 'Deliveroo', type: 'delivery', commission: 25, status: 'inactive' },
            { id: 7, name: 'Talabat', type: 'app', commission: 22, status: 'active' },
            { id: 8, name: 'Keeta', type: 'other', commission: 5, status: 'active' },
            { id: 9, name: 'Talabana', type: 'other', commission: 8, status: 'inactive' },
            { id: 10, name: 'Other', type: 'other', commission: 0, status: 'active' }
          ],
          sales: {
            '2024': {
              'Hamdan St': 10044612,
              'Khalidiya': 7560619,
              'Shabiya 11': 6928826,
              'Muroor': 2665400,
              'Barsha': 7052043,
              'Satwa': 3894932,
              'ELctria': 4257965,
              'Rigga': 0
            },
            '2025': {
              'Hamdan St': 7444537,
              'Khalidiya': 6039662,
              'Shabiya 11': 6581989,
              'Muroor': 2440240,
              'Barsha': 6257407,
              'Satwa': 4774601,
              'ELctria': 7637929,
              'Rigga': 850068
            }
          }
        };
      }

      loadData() {
        const savedData = localStorage.getItem('salesDashboardData');
        if (savedData) {
          this.data = JSON.parse(savedData);
        }
        this.branches = this.data.branches;
        this.channels = this.data.channels;
        this.salesData = this.data.sales;
      }

      saveData() {
        this.data.branches = this.branches;
        this.channels = this.channels;
        this.data.sales = this.salesData;
        localStorage.setItem('salesDashboardData', JSON.stringify(this.data));
        this.updateDataStatus('Data saved successfully!');
      }

      updateDataStatus(message) {
        const statusEl = document.getElementById('dataStatus');
        statusEl.textContent = message;
        statusEl.style.color = 'var(--success)';
        setTimeout(() => {
          statusEl.textContent = 'Data saved locally';
          statusEl.style.color = 'var(--muted)';
        }, 3000);
      }

      showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
          <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
          <span>${message}</span>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.classList.add('show');
        }, 100);
        
        setTimeout(() => {
          notification.classList.remove('show');
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 300);
        }, 3000);
      }

      setupEventListeners() {
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
          tab.addEventListener('click', () => this.switchTab(tab.dataset.tab));
        });

        // Data management buttons
        document.getElementById('saveBtn').addEventListener('click', () => this.saveData());
        document.getElementById('exportBtn').addEventListener('click', () => this.exportData());
        document.getElementById('importBtn').addEventListener('click', () => this.importData());
        document.getElementById('resetDataBtn').addEventListener('click', () => this.resetData());

        // Branch management
        document.getElementById('addBranchBtn').addEventListener('click', () => this.addBranch());

        // Channel management
        document.getElementById('addChannelBtn').addEventListener('click', () => this.addChannel());

        // Raw data management
        document.getElementById('updateDataBtn').addEventListener('click', () => this.updateRawData());
        
        // Raw data parsing
        document.getElementById('parseAndIntegrateBtn').addEventListener('click', () => this.parseAndIntegrateRawData());

        // Channel filters
        document.querySelectorAll('.chip').forEach(chip => {
          chip.addEventListener('click', () => this.filterChannel(chip.dataset.channel));
        });

        // Report export
        document.getElementById('exportReportBtn').addEventListener('click', () => this.exportReport());
      }

      switchTab(tabName) {
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        document.getElementById(`${tabName}-tab`).classList.add('active');
      }

      // Raw Data Parsing
      parseDataString(rawDataString) {
        const lines = rawDataString.split('\n').map(line => line.trim()).filter(line => line);
        const headers = lines[0].split('\t').map(h => h.trim());
        
        const data = [];
        for (let i = 1; i < lines.length; i++) {
          const values = lines[i].split('\t');
          const row = {};
          
          for (let j = 0; j < headers.length; j++) {
            let value = values[j] ? values[j].trim() : '';
            
            // Remove commas and convert to number if possible
            if (value !== '') {
              value = value.replace(/,/g, '');
              const num = parseFloat(value);
              if (!isNaN(num)) {
                row[headers[j]] = num;
              } else {
                row[headers[j]] = value;
              }
            } else {
              row[headers[j]] = value;
            }
          }
          
          data.push(row);
        }
        
        return data;
      }

      parseAndIntegrateRawData() {
        const rawDataInput = document.getElementById('rawDataString').value;
        if (!rawDataInput) {
          this.showNotification('Please paste the raw data string first', 'error');
          return;
        }
        
        try {
          this.rawDataString = rawDataInput;
          this.parsedData = this.parseDataString(this.rawDataString);
          
          // Show data preview
          this.showDataPreview();
          
          // Process the raw data
          this.processRawData();
          
          // Update dashboard data
          this.updateDashboardData();
          
          // Re-render dashboard
          this.renderDashboard();
          this.renderBranches();
          this.renderChannels();
          this.renderReports();
          
          // Save data
          this.saveData();
          
          this.showNotification('Raw data parsed and integrated successfully!', 'success');
        } catch (error) {
          console.error('Error parsing raw data:', error);
          this.showNotification('Error parsing raw data. Please check the format.', 'error');
        }
      }

      processRawData() {
        // Initialize data structures
        this.rawDataChannels = [
          'Dining /takeaway', 'TALABAT', 'TABNA', 'Keeta CARD', 'NOON CARD',
          'Delivery', 'Careem CARD', 'SMILES CARD', 'DELIVERO CARD', 'Online cash'
        ];
        
        this.rawDataBranches = [];
        this.monthlyData = { 2024: {}, 2025: {} };
        
        // Process each row
        this.parsedData.forEach(row => {
          const branch = row.Branch;
          const month = row.Month;
          const year = row.Year;
          
          if (!branch || !month || !year) return;
          
          // Add to branches list
          if (!this.rawDataBranches.includes(branch)) {
            this.rawDataBranches.push(branch);
          }
          
          // Initialize monthly data structure
          if (!this.monthlyData[year][branch]) {
            this.monthlyData[year][branch] = {};
          }
          
          if (!this.monthlyData[year][branch][month]) {
            this.monthlyData[year][branch][month] = 0;
          }
          
          // Sum all channel sales
          this.rawDataChannels.forEach(channel => {
            if (row[channel] && typeof row[channel] === 'number') {
              this.monthlyData[year][branch][month] += row[channel];
            }
          });
        });
        
        // Aggregate yearly data
        this.aggregateYearlyData();
      }

      aggregateYearlyData() {
        // Initialize sales data
        this.salesData = { 2024: {}, 2025: {} };
        
        // Aggregate monthly data to yearly
        Object.keys(this.monthlyData).forEach(year => {
          Object.keys(this.monthlyData[year]).forEach(branch => {
            if (!this.salesData[year][branch]) {
              this.salesData[year][branch] = 0;
            }
            
            // Sum all months for the branch
            Object.values(this.monthlyData[year][branch]).forEach(monthTotal => {
              this.salesData[year][branch] += monthTotal;
            });
          });
        });
      }

      updateDashboardData() {
        // Update branches
        this.branches = this.rawDataBranches.map((name, index) => ({
          id: Date.now() + index,
          name: name,
          location: 'Unknown',
          manager: 'Unknown',
          status: 'active'
        }));
        
        // Update channels
        this.channels = this.rawDataChannels.map((name, index) => ({
          id: Date.now() + index,
          name: name,
          type: this.getChannelType(name),
          commission: 0, // Default commission
          status: 'active'
        }));
      }

      getChannelType(channelName) {
        if (channelName.includes('Delivery') || channelName.includes('DELIVERO')) {
          return 'delivery';
        } else if (channelName.includes('Online') || channelName.includes('CARD')) {
          return 'online';
        } else if (channelName.includes('Careem') || channelName.includes('Noon') || channelName.includes('Talabat') || channelName.includes('Smile')) {
          return 'app';
        } else {
          return 'other';
        }
      }

      showDataPreview() {
        const preview = document.getElementById('dataPreview');
        const tbody = preview.querySelector('tbody');
        
        // Show first 10 rows as preview
        const previewData = this.parsedData.slice(0, 10);
        
        tbody.innerHTML = previewData.map(row => {
          // Calculate total sales for the row
          let totalSales = 0;
          this.rawDataChannels.forEach(col => {
            if (row[col] && typeof row[col] === 'number') {
              totalSales += row[col];
            }
          });
          
          // Get channel names
          const channels = this.rawDataChannels.filter(col => row[col] && row[col] > 0).join(', ');
          
          return `
            <tr>
              <td>${row.Branch || 'N/A'}</td>
              <td>${row.Month || 'N/A'}</td>
              <td>${row.Year || 'N/A'}</td>
              <td>$${totalSales.toLocaleString()}</td>
              <td>${channels || 'None'}</td>
            </tr>
          `;
        }).join('');
        
        preview.style.display = 'block';
      }

      // Branch Management
      addBranch() {
        const name = document.getElementById('branchName').value;
        const location = document.getElementById('branchLocation').value;
        const manager = document.getElementById('branchManager').value;
        const status = document.getElementById('branchStatus').value;

        if (!name || !location || !manager) {
          this.showNotification('Please fill in all required fields', 'error');
          return;
        }

        const newBranch = {
          id: Date.now(),
          name,
          location,
          manager,
          status
        };

        this.branches.push(newBranch);
        this.salesData['2025'][name] = 0;
        this.salesData['2024'][name] = 0;

        document.getElementById('branchName').value = '';
        document.getElementById('branchLocation').value = '';
        document.getElementById('branchManager').value = '';
        
        this.renderBranches();
        this.renderDashboard();
        this.saveData();
      }

      editBranch(id) {
        const branch = this.branches.find(b => b.id === id);
        if (branch) {
          const newName = prompt('Enter new branch name:', branch.name);
          if (newName && newName !== branch.name) {
            // Update sales data keys
            this.salesData['2025'][newName] = this.salesData['2025'][branch.name];
            this.salesData['2024'][newName] = this.salesData['2024'][branch.name];
            delete this.salesData['2025'][branch.name];
            delete this.salesData['2024'][branch.name];
            
            branch.name = newName;
            this.renderBranches();
            this.renderDashboard();
            this.saveData();
          }
        }
      }

      deleteBranch(id) {
        if (confirm('Are you sure you want to delete this branch?')) {
          const branch = this.branches.find(b => b.id === id);
          if (branch) {
            delete this.salesData['2025'][branch.name];
            delete this.salesData['2024'][branch.name];
            this.branches = this.branches.filter(b => b.id !== id);
            this.renderBranches();
            this.renderDashboard();
            this.saveData();
          }
        }
      }

      renderBranches() {
        const tbody = document.getElementById('branchesTableBody');
        tbody.innerHTML = this.branches.map(branch => `
          <tr>
            <td>${branch.name}</td>
            <td>${branch.location}</td>
            <td>${branch.manager}</td>
            <td>
              <span class="chip ${branch.status === 'active' ? 'positive' : branch.status === 'inactive' ? 'negative' : 'neutral'}">
                ${branch.status}
              </span>
            </td>
            <td>
              <button class="btn-sm btn-primary" onclick="salesManager.editBranch(${branch.id})">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-sm btn-danger" onclick="salesManager.deleteBranch(${branch.id})">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `).join('');
      }

      // Channel Management
      addChannel() {
        const name = document.getElementById('channelName').value;
        const type = document.getElementById('channelType').value;
        const commission = document.getElementById('channelCommission').value;
        const status = document.getElementById('channelStatus').value;

        if (!name || !type || !commission) {
          this.showNotification('Please fill in all required fields', 'error');
          return;
        }

        const newChannel = {
          id: Date.now(),
          name,
          type,
          commission: parseFloat(commission),
          status
        };

        this.channels.push(newChannel);

        document.getElementById('channelName').value = '';
        document.getElementById('channelCommission').value = '';
        
        this.renderChannels();
        this.saveData();
      }

      editChannel(id) {
        const channel = this.channels.find(c => c.id === id);
        if (channel) {
          const newName = prompt('Enter new channel name:', channel.name);
          if (newName && newName !== channel.name) {
            channel.name = newName;
            this.renderChannels();
            this.saveData();
          }
        }
      }

      deleteChannel(id) {
        if (confirm('Are you sure you want to delete this channel?')) {
          this.channels = this.channels.filter(c => c.id !== id);
          this.renderChannels();
          this.saveData();
        }
      }

      renderChannels() {
        const tbody = document.getElementById('channelsTableBody');
        tbody.innerHTML = this.channels.map(channel => `
          <tr>
            <td>${channel.name}</td>
            <td>${channel.type}</td>
            <td>${channel.commission}%</td>
            <td>
              <span class="chip ${channel.status === 'active' ? 'positive' : channel.status === 'inactive' ? 'negative' : 'neutral'}">
                ${channel.status}
              </span>
            </td>
            <td>
              <button class="btn-sm btn-primary" onclick="salesManager.editChannel(${channel.id})">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-sm btn-danger" onclick="salesManager.deleteChannel(${channel.id})">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `).join('');
      }

      // Raw Data Management
      renderRawData() {
        const rawDataEl = document.getElementById('rawData');
        rawDataEl.value = JSON.stringify(this.data, null, 2);
      }

      updateRawData() {
        try {
          const newData = JSON.parse(document.getElementById('rawData').value);
          this.data = newData;
          this.branches = this.data.branches;
          this.channels = this.data.channels;
          this.salesData = this.data.sales;
          
          this.renderBranches();
          this.renderChannels();
          this.renderDashboard();
          this.saveData();
        } catch (e) {
          this.showNotification('Invalid JSON data', 'error');
        }
      }

      // Data Export/Import
      exportData() {
        const dataStr = JSON.stringify(this.data, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'sales-dashboard-data.json';
        link.click();
        URL.revokeObjectURL(url);
      }

      importData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = (e) => {
          const file = e.target.files[0];
          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const importedData = JSON.parse(event.target.result);
              this.data = importedData;
              this.branches = this.data.branches;
              this.channels = this.data.channels;
              this.salesData = this.data.sales;
              
              this.renderBranches();
              this.renderChannels();
              this.renderDashboard();
              this.renderRawData();
              this.saveData();
            } catch (e) {
              this.showNotification('Invalid file format', 'error');
            }
          };
          reader.readAsText(file);
        };
        input.click();
      }

      resetData() {
        if (confirm('Are you sure you want to reset all data to default?')) {
          this.data = this.loadDefaultData();
          this.branches = this.data.branches;
          this.channels = this.data.channels;
          this.salesData = this.data.sales;
          
          this.renderBranches();
          this.renderChannels();
          this.renderDashboard();
          this.renderRawData();
          this.saveData();
        }
      }

      // Report Export
      exportReport() {
        let csv = 'Branch Performance Summary\n';
        csv += 'Branch,2025 Total,2024 Total,Difference,Growth %\n';
        
        // Generate branch report data
        const branchReportData = this.generateBranchReportData();
        branchReportData.forEach(row => {
          csv += `${row.branch},${row.total2025},${row.total2024},${row.difference},${row.growth}\n`;
        });
        
        csv += '\nChannel Performance Overview\n';
        csv += 'Channel,2025,2024,Difference,% Growth\n';
        
        // Generate channel report data
        const channelReportData = this.generateChannelReportData();
        channelReportData.forEach(row => {
          csv += `${row.channel},${row.total2025},${row.total2024},${row.difference},${row.growth}\n`;
        });
        
        csv += '\nMonthly Trend Analysis\n';
        csv += 'Month,2024,2025,Change,Trend\n';
        
        // Generate monthly report data
        const monthlyReportData = this.generateMonthlyReportData();
        monthlyReportData.forEach(row => {
          csv += `${row.month},${row.total2024},${row.total2025},${row.change},${row.trend}\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'sales-performance-report.csv';
        link.click();
        URL.revokeObjectURL(url);
      }

      // Report Generation
      generateBranchReportData() {
        const branches = this.branches.map(b => b.name);
        const reportData = [];
        
        branches.forEach(branch => {
          const total2024 = this.salesData['2024'][branch] || 0;
          const total2025 = this.salesData['2025'][branch] || 0;
          const difference = total2025 - total2024;
          const growth = total2024 > 0 ? ((difference / total2024) * 100).toFixed(1) : 0;
          
          reportData.push({
            branch,
            total2024,
            total2025,
            difference,
            growth
          });
        });
        
        return reportData;
      }

      generateChannelReportData() {
        const channels = this.channels.map(c => c.name);
        const reportData = [];
        
        channels.forEach(channel => {
          // Simulate channel data based on branch data
          let total2024 = 0;
          let total2025 = 0;
          
          this.branches.forEach(branch => {
            const branch2024 = this.salesData['2024'][branch] || 0;
            const branch2025 = this.salesData['2025'][branch] || 0;
            
            // Distribute branch sales proportionally to channels
            total2024 += branch2024 * 0.1; // 10% per channel
            total2025 += branch2025 * 0.1; // 10% per channel
          });
          
          const difference = total2025 - total2024;
          const growth = total2024 > 0 ? ((difference / total2024) * 100).toFixed(1) : 0;
          
          reportData.push({
            channel,
            total2024,
            total2025,
            difference,
            growth
          });
        });
        
        return reportData;
      }

      generateMonthlyReportData() {
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct'];
        const reportData = [];
        
        months.forEach(month => {
          let total2024 = 0;
          let total2025 = 0;
          
          // Sum monthly data
          Object.keys(this.monthlyData['2024']).forEach(branch => {
            if (this.monthlyData['2024'][branch][month]) {
              total2024 += this.monthlyData['2024'][branch][month];
            }
          });
          
          Object.keys(this.monthlyData['2025']).forEach(branch => {
            if (this.monthlyData['2025'][branch][month]) {
              total2025 += this.monthlyData['2025'][branch][month];
            }
          });
          
          const change = total2025 - total2024;
          const trend = change > 0 ? 'Growth' : change < 0 ? 'Decline' : 'Neutral';
          
          reportData.push({
            month,
            total2024,
            total2025,
            change,
            trend
          });
        });
        
        return reportData;
      }

      renderReports() {
        this.renderBranchReport();
        this.renderChannelReport();
        this.renderMonthlyReport();
      }

      renderBranchReport() {
        const tbody = document.getElementById('branchReportBody');
        const reportData = this.generateBranchReportData();
        
        tbody.innerHTML = reportData.map(row => {
          const growthClass = row.growth > 0 ? 'growth-positive' : row.growth < 0 ? 'growth-negative' : 'neutral';
          const growthSymbol = row.growth > 0 ? 'ðŸ”¼' : row.growth < 0 ? 'ðŸ”»' : '';
          const growthText = row.growth > 0 ? 'Growth' : row.growth < 0 ? 'Decline' : 'Neutral';
          
          return `
            <tr>
              <td>${row.branch}</td>
              <td>$${row.total2025.toLocaleString()}</td>
              <td>$${row.total2024.toLocaleString()}</td>
              <td>$${row.difference.toLocaleString()}</td>
              <td class="${growthClass}">${growthSymbol} ${Math.abs(row.growth)}% ${growthText}</td>
            </tr>
          `;
        }).join('');
      }

      renderChannelReport() {
        const tbody = document.getElementById('channelReportBody');
        const reportData = this.generateChannelReportData();
        
        tbody.innerHTML = reportData.map(row => {
          const growthClass = row.growth > 0 ? 'growth-positive' : row.growth < 0 ? 'growth-negative' : 'neutral';
          const growthSymbol = row.growth > 0 ? 'ðŸ”¼' : row.growth < 0 ? 'ðŸ”»' : '';
          const growthText = row.growth > 0 ? 'Growth' : row.growth < 0 ? 'Decline' : 'Neutral';
          
          return `
            <tr>
              <td>${row.channel}</td>
              <td>$${row.total2025.toLocaleString()}</td>
              <td>$${row.total2024.toLocaleString()}</td>
              <td>$${row.difference.toLocaleString()}</td>
              <td class="${growthClass}">${growthSymbol} ${Math.abs(row.growth)}% ${growthText}</td>
            </tr>
          `;
        }).join('');
      }

      renderMonthlyReport() {
        const tbody = document.getElementById('monthlyReportBody');
        const reportData = this.generateMonthlyReportData();
        
        tbody.innerHTML = reportData.map(row => {
          const trendClass = row.trend === 'Growth' ? 'growth-positive' : row.trend === 'Decline' ? 'growth-negative' : 'neutral';
          
          return `
            <tr>
              <td>${row.month}</td>
              <td>$${row.total2024.toLocaleString()}</td>
              <td>$${row.total2025.toLocaleString()}</td>
              <td>$${row.change.toLocaleString()}</td>
              <td class="${trendClass}">${row.trend}</td>
            </tr>
          `;
        }).join('');
      }

      // Dashboard Rendering
      renderDashboard() {
        this.renderCharts();
        this.updateKPIs();
      }

      renderCharts() {
        this.renderBranchChart();
        this.renderMonthlyChart();
        this.renderChannelChart();
      }

      renderBranchChart() {
        const ctx = document.getElementById('branchChart').getContext('2d');
        if (this.branchChart) this.branchChart.destroy();
        
        const labels = this.branches.map(b => b.name);
        const data2024 = labels.map(name => this.salesData['2024'][name] || 0);
        const data2025 = labels.map(name => this.salesData['2025'][name] || 0);

        this.branchChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              { label: '2024', data: data2024, backgroundColor: '#bee3f8', borderColor: '#90cdf4', borderWidth: 1 },
              { label: '2025', data: data2025, backgroundColor: '#fbd38d', borderColor: '#f6ad55', borderWidth: 1 }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'top' } },
            scales: {
              y: { 
                beginAtZero: true,
                ticks: { callback: value => '$' + value.toLocaleString() }
              }
            }
          }
        });
      }

      renderMonthlyChart() {
        const ctx = document.getElementById('monthlyChart').getContext('2d');
        if (this.monthlyChart) this.monthlyChart.destroy();
        
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct'];
        
        // Calculate monthly totals from raw data
        const monthly2024 = months.map(month => {
          let total = 0;
          Object.keys(this.monthlyData['2024']).forEach(branch => {
            if (this.monthlyData['2024'][branch][month]) {
              total += this.monthlyData['2024'][branch][month];
            }
          });
          return total;
        });
        
        const monthly2025 = months.map(month => {
          let total = 0;
          Object.keys(this.monthlyData['2025']).forEach(branch => {
            if (this.monthlyData['2025'][branch][month]) {
              total += this.monthlyData['2025'][branch][month];
            }
          });
          return total;
        });

        this.monthlyChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: months,
            datasets: [
              { label: '2024', data: monthly2024, borderColor: '#bee3f8', backgroundColor: 'rgba(190, 227, 248, 0.2)', tension: 0.3, fill: true },
              { label: '2025', data: monthly2025, borderColor: '#fbd38d', backgroundColor: 'rgba(251, 211, 141, 0.2)', tension: 0.3, fill: true }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'top' } },
            scales: {
              y: { 
                beginAtZero: true,
                ticks: { callback: value => '$' + value.toLocaleString() }
              }
            }
          }
        });
      }

      renderChannelChart() {
        const ctx = document.getElementById('channelChart').getContext('2d');
        if (this.channelChart) this.channelChart.destroy();
        
        const activeChannel = document.querySelector('.chip.active').dataset.channel;
        const filteredChannels = activeChannel === 'all' 
          ? this.channels 
          : this.channels.filter(c => c.name === activeChannel);
        
        const labels = filteredChannels.map(c => c.name);
        const data2024 = labels.map(name => {
          // Simulate channel data from branch totals
          return this.branches.reduce((sum, branch) => {
            return sum + (Math.random() * 1000000); // Simulated data
          }, 0);
        });
        const data2025 = labels.map(name => {
          return this.branches.reduce((sum, branch) => {
            return sum + (Math.random() * 1000000); // Simulated data
          }, 0);
        });

        this.channelChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              { label: '2024', data: data2024, backgroundColor: '#c6f6d5', borderColor: '#9ae6b4', borderWidth: 1 },
              { label: '2025', data: data2025, backgroundColor: '#fbb6ce', borderColor: '#f687b3', borderWidth: 1 }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'top' } },
            scales: {
              y: { 
                beginAtZero: true,
                ticks: { callback: value => '$' + value.toLocaleString() }
              }
            }
          }
        });
      }

      filterChannel(channel) {
        document.querySelectorAll('.chip').forEach(chip => chip.classList.remove('active'));
        document.querySelector(`[data-channel="${channel}"]`).classList.add('active');
        this.renderChannelChart();
      }

      updateKPIs() {
        const total2024 = Object.values(this.salesData['2024']).reduce((sum, val) => sum + val, 0);
        const total2025 = Object.values(this.salesData['2025']).reduce((sum, val) => sum + val, 0);
        const growth = ((total2025 - total2024) / total2024 * 100).toFixed(1);
        
        document.getElementById('total2024').textContent = '$' + total2024.toLocaleString();
        document.getElementById('total2025').textContent = '$' + total2025.toLocaleString();
        
        // Create growth element if it doesn't exist
        let growthElement = document.getElementById('growthPct');
        if (!growthElement) {
          const kpi = document.querySelector('.kpi:nth-child(2) .trend');
          growthElement = document.createElement('span');
          growthElement.id = 'growthPct';
          kpi.appendChild(growthElement);
        }
        
        growthElement.textContent = (growth > 0 ? 'â†‘' : 'â†“') + ' ' + Math.abs(growth) + '%';
        growthElement.className = 'trend ' + (growth > 0 ? 'positive' : 'negative');
        
        // Update top branch
        const topBranchElement = document.getElementById('topBranch');
        if (topBranchElement) {
          const branchGrowth = this.branches.map(b => ({
            name: b.name,
            growth: ((this.salesData['2025'][b.name] - this.salesData['2024'][b.name]) / this.salesData['2024'][b.name] * 100).toFixed(1)
          })).sort((a, b) => b.growth - a.growth)[0];
          
          topBranchElement.textContent = branchGrowth ? branchGrowth.name : 'N/A';
        }
      }
    }

    // Initialize the application
    const salesManager = new SalesDataManager();
  </script>
</body>
</html>
