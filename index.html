<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Crispy Chicken ‚Äî Comprehensive Sales Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* CSS Variables */
    :root {
      --bg: #ffffff;
      --card: #f8fafb;
      --muted: #6b7280;
      --accent: #3b82f6;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --glass: rgba(15, 23, 42, 0.03);
      --border: #e5e7eb;
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      --edit-bg: #fef3c7;
      --edit-border: #f59e0b;
    }

    /* Base Styles */
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body {
      background: var(--bg);
      color: #0f172a;
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container { max-width: 1400px; margin: 20px auto; padding: 20px; }

    /* Header Styles */
    header {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }

    .header-title h1 {
      font-size: 24px;
      margin: 0;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-title .subtitle {
      font-size: 14px;
      color: var(--muted);
      margin-top: 4px;
    }

    .header-controls {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .control-group label {
      font-size: 13px;
      color: var(--muted);
      font-weight: 500;
    }

    select, button {
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: white;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    select:hover, button:hover {
      border-color: var(--accent);
    }

    button.primary {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    button.primary:hover {
      background: #2563eb;
    }

    button.success {
      background: var(--success);
      color: white;
      border-color: var(--success);
    }

    button.warning {
      background: var(--warning);
      color: white;
      border-color: var(--warning);
    }

    button.danger {
      background: var(--danger);
      color: white;
      border-color: var(--danger);
    }

    /* Tab Navigation */
    .tab-nav {
      display: flex;
      gap: 4px;
      background: var(--card);
      padding: 4px;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .tab-button {
      flex: 1;
      padding: 12px 20px;
      border: none;
      background: transparent;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: var(--muted);
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .tab-button.active {
      background: white;
      color: var(--accent);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .tab-button:hover:not(.active) {
      background: rgba(255, 255, 255, 0.5);
    }

    .tab-icon {
      font-size: 18px;
    }

    /* Content Area */
    .content-area {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: var(--shadow);
      min-height: 600px;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Grid Layout */
    .grid {
      display: grid;
      gap: 20px;
      margin-bottom: 24px;
    }

    .grid-2 { grid-template-columns: repeat(2, 1fr); }
    .grid-3 { grid-template-columns: repeat(3, 1fr); }
    .grid-4 { grid-template-columns: repeat(4, 1fr); }

    /* Cards */
    .card {
      background: var(--card);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      margin: 0 0 16px 0;
      color: #1f2937;
    }

    /* KPI Cards */
    .kpi-card {
      text-align: center;
    }

    .kpi-value {
      font-size: 32px;
      font-weight: 700;
      margin: 8px 0;
      color: #1f2937;
    }

    .kpi-label {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .kpi-change {
      font-size: 14px;
      font-weight: 500;
      padding: 4px 8px;
      border-radius: 6px;
      display: inline-block;
    }

    .kpi-change.positive {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
    }

    .kpi-change.negative {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
    }

    /* Tables */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
    }

    .data-table th {
      background: #f9fafb;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      font-size: 13px;
      color: #374151;
      border-bottom: 2px solid var(--border);
    }

    .data-table td {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
    }

    .data-table tr:hover {
      background: #f9fafb;
    }

    .sortable {
      cursor: pointer;
      user-select: none;
    }

    .sortable:hover {
      color: var(--accent);
    }

    .sortable::after {
      content: ' ‚Üï';
      opacity: 0.3;
    }

    .sortable.asc::after {
      content: ' ‚Üë';
      opacity: 1;
    }

    .sortable.desc::after {
      content: ' ‚Üì';
      opacity: 1;
    }

    /* Charts */
    .chart-container {
      position: relative;
      height: 400px;
      margin-top: 16px;
    }

    /* Comparison Card */
    .comparison-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(135deg, #f8fafb 0%, #e0e7ff 100%);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .comparison-item {
      text-align: center;
      flex: 1;
    }

    .comparison-year {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .comparison-value {
      font-size: 28px;
      font-weight: 700;
      color: #1f2937;
    }

    .comparison-arrow {
      font-size: 24px;
      margin: 0 20px;
    }

    /* Edit Mode Styles */
    .editable {
      cursor: pointer;
      position: relative;
    }

    .editable:hover::after {
      content: '‚úèÔ∏è';
      position: absolute;
      right: -20px;
      top: 0;
      font-size: 14px;
    }

    .edit-mode {
      background: var(--edit-bg);
      border: 1px solid var(--edit-border);
    }

    .edit-input {
      background: white;
      border: 2px solid var(--accent);
      border-radius: 4px;
      padding: 4px 8px;
      font-size: inherit;
      font-weight: inherit;
      width: 100%;
    }

    .edit-actions {
      margin-top: 10px;
      display: flex;
      gap: 8px;
    }

    .edit-table-container {
      margin-top: 20px;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      background: white;
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .grid-4 { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 900px) {
      .grid-3, .grid-2 { grid-template-columns: 1fr; }
      .header-title h1 { font-size: 20px; }
      .tab-button { font-size: 13px; padding: 10px 16px; }
    }

    @media (max-width: 600px) {
      .container { padding: 10px; }
      header { flex-direction: column; align-items: stretch; }
      .header-controls { justify-content: center; }
      .tab-nav { flex-direction: column; }
      .kpi-value { font-size: 24px; }
    }

    /* Loading Spinner */
    .spinner {
      border: 3px solid var(--border);
      border-top: 3px solid var(--accent);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 50px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Notification */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 20px;
      background: var(--success);
      color: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      opacity: 0;
      transform: translateY(-20px);
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .notification.show {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header>
      <div class="header-title">
        <h1>üçó Crispy Chicken Sales Dashboard</h1>
        <div class="subtitle">Comprehensive Sales Performance Analysis</div>
      </div>
      <div class="header-controls">
        <div class="control-group">
          <label for="yearToggle">Year</label>
          <select id="yearToggle">
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
          </select>
        </div>
        <div class="control-group">
          <label for="periodToggle">Period</label>
          <select id="periodToggle">
            <option value="monthly">Monthly</option>
            <option value="weekly">Weekly</option>
          </select>
        </div>
        <div class="control-group">
          <label for="branchFilter">Branch</label>
          <select id="branchFilter">
            <option value="all">All Branches</option>
          </select>
        </div>
        <button id="editBtn" class="warning">‚úèÔ∏è Edit Data</button>
        <button id="resetBtn" class="danger">‚Ü∫ Reset</button>
        <button id="exportBtn" class="primary">üì• Export CSV</button>
      </div>
    </header>

    <!-- Tab Navigation -->
    <nav class="tab-nav">
      <button class="tab-button active" data-tab="overview">
        <span class="tab-icon">üìä</span>
        Executive Overview
      </button>
      <button class="tab-button" data-tab="branches">
        <span class="tab-icon">üè¢</span>
        Branch Comparison
      </button>
      <button class="tab-button" data-tab="channels">
        <span class="tab-icon">üì±</span>
        Channel Performance
      </button>
    </nav>

    <!-- Content Area -->
    <main class="content-area">
      <!-- Executive Overview Tab -->
      <section id="overview" class="tab-content active">
        <!-- Year Comparison Card -->
        <div class="comparison-card">
          <div class="comparison-item">
            <div class="comparison-year">2024 Total Sales</div>
            <div class="comparison-value" id="total2024">-</div>
          </div>
          <div class="comparison-arrow">üîÑ</div>
          <div class="comparison-item">
            <div class="comparison-year">2025 Total Sales</div>
            <div class="comparison-value" id="total2025">-</div>
          </div>
          <div class="comparison-arrow" id="growthArrow">üîº</div>
          <div class="comparison-item">
            <div class="comparison-year">Growth Rate</div>
            <div class="comparison-value" id="growthRate">-</div>
          </div>
        </div>

        <div class="grid grid-4">
          <div class="card kpi-card">
            <div class="kpi-label">Top Branch</div>
            <div class="kpi-value" id="topBranch">-</div>
            <div class="kpi-change" id="topBranchChange">-</div>
          </div>
          <div class="card kpi-card">
            <div class="kpi-label">Top Channel</div>
            <div class="kpi-value" id="topChannel">-</div>
            <div class="kpi-change" id="topChannelChange">-</div>
          </div>
          <div class="card kpi-card">
            <div class="kpi-label">Avg Weekly Sales</div>
            <div class="kpi-value" id="avgWeekly">-</div>
            <div class="kpi-change" id="avgWeeklyChange">-</div>
          </div>
          <div class="card kpi-card">
            <div class="kpi-label">Peak Period</div>
            <div class="kpi-value" id="peakPeriod">-</div>
            <div class="kpi-change" id="peakPeriodChange">-</div>
          </div>
        </div>

        <div class="grid grid-2">
          <div class="card">
            <h3 class="card-title">Sales Trend (<span id="periodLabel">Monthly</span>)</h3>
            <div class="chart-container">
              <canvas id="trendChart"></canvas>
            </div>
          </div>
          <div class="card">
            <h3 class="card-title">Branch Performance Distribution</h3>
            <div class="chart-container">
              <canvas id="branchDistChart"></canvas>
            </div>
          </div>
        </div>

        <div class="card">
          <h3 class="card-title">Channel Performance Overview</h3>
          <div class="chart-container">
            <canvas id="channelOverviewChart"></canvas>
          </div>
        </div>

        <!-- Edit Table Container (hidden by default) -->
        <div id="editTableContainer" class="edit-table-container" style="display: none;">
          <h3 class="card-title">Edit Total Sales Data</h3>
          <div class="grid grid-2">
            <div class="card">
              <div class="kpi-label">Total Sales 2024</div>
              <input type="number" id="editTotal2024" class="edit-input" />
            </div>
            <div class="card">
              <div class="kpi-label">Total Sales 2025</div>
              <input type="number" id="editTotal2025" class="edit-input" />
            </div>
          </div>
          <div class="edit-actions">
            <button id="saveTotalBtn" class="success">Save Changes</button>
            <button id="cancelEditBtn" class="danger">Cancel</button>
          </div>
        </div>
      </section>

      <!-- Branch Comparison Tab -->
      <section id="branches" class="tab-content">
        <div class="card">
          <h3 class="card-title">Branch Sales Comparison (2024 vs 2025)</h3>
          <div class="chart-container">
            <canvas id="branchComparisonChart"></canvas>
          </div>
        </div>

        <div class="card" style="margin-top: 20px;">
          <h3 class="card-title">Detailed Branch Performance</h3>
          <div style="overflow-x: auto;">
            <table class="data-table" id="branchTable">
              <thead>
                <tr>
                  <th class="sortable" data-sort="name">Branch Name</th>
                  <th class="sortable" data-sort="2024">2024 Sales</th>
                  <th class="sortable" data-sort="2025">2025 Sales</th>
                  <th class="sortable" data-sort="growth">Growth %</th>
                  <th class="sortable" data-sort="channel">Top Channel</th>
                  <th class="sortable" data-sort="weekly">Avg Weekly</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Edit Table Container (hidden by default) -->
        <div id="branchEditContainer" class="edit-table-container" style="display: none;">
          <h3 class="card-title">Edit Branch Sales Data</h3>
          <div style="overflow-x: auto;">
            <table class="data-table" id="branchEditTable">
              <thead>
                <tr>
                  <th>Branch Name</th>
                  <th>2024 Sales</th>
                  <th>2025 Sales</th>
                  <th>Avg Weekly</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="edit-actions">
            <button id="saveBranchBtn" class="success">Save Changes</button>
            <button id="cancelBranchEditBtn" class="danger">Cancel</button>
          </div>
        </div>
      </section>

      <!-- Channel Performance Tab -->
      <section id="channels" class="tab-content">
        <div class="grid grid-2">
          <div class="card">
            <h3 class="card-title">Channel Sales by Year</h3>
            <div class="chart-container">
              <canvas id="channelYearChart"></canvas>
            </div>
          </div>
          <div class="card">
            <h3 class="card-title">Channel Growth Comparison</h3>
            <div class="chart-container">
              <canvas id="channelGrowthChart"></canvas>
            </div>
          </div>
        </div>

        <div class="card">
          <h3 class="card-title">Channel Performance by Branch</h3>
          <div class="chart-container">
            <canvas id="channelBranchChart"></canvas>
          </div>
        </div>

        <div class="card" style="margin-top: 20px;">
          <h3 class="card-title">Channel Performance Details</h3>
          <div style="overflow-x: auto;">
            <table class="data-table" id="channelTable">
              <thead>
                <tr>
                  <th class="sortable" data-sort="channel">Channel</th>
                  <th class="sortable" data-sort="2024">2024 Sales</th>
                  <th class="sortable" data-sort="2025">2025 Sales</th>
                  <th class="sortable" data-sort="growth">Growth %</th>
                  <th class="sortable" data-sort="branch">Top Branch</th>
                  <th class="sortable" data-sort="weekly">Avg Weekly</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Edit Table Container (hidden by default) -->
        <div id="channelEditContainer" class="edit-table-container" style="display: none;">
          <h3 class="card-title">Edit Channel Sales Data</h3>
          <div class="control-group" style="margin-bottom: 16px;">
            <label for="channelBranchSelect">Select Branch:</label>
            <select id="channelBranchSelect">
              <option value="all">All Branches</option>
            </select>
          </div>
          <div style="overflow-x: auto;">
            <table class="data-table" id="channelEditTable">
              <thead>
                <tr>
                  <th>Channel</th>
                  <th>2024 Sales</th>
                  <th>2025 Sales</th>
                  <th>Avg Weekly</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="edit-actions">
            <button id="saveChannelBtn" class="success">Save Changes</button>
            <button id="cancelChannelEditBtn" class="danger">Cancel</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Notification -->
  <div class="notification" id="notification"></div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Main Application -->
  <script>
    (function() {
      'use strict';

      // Data Object with weekly breakdown
      const DATA = {
        months: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct'],
        weeks: ['Week 1','Week 2','Week 3','Week 4','Week 5','Week 6','Week 7','Week 8','Week 9','Week 10','Week 11','Week 12','Week 13','Week 14','Week 15','Week 16','Week 17','Week 18','Week 19','Week 20','Week 21','Week 22','Week 23','Week 24','Week 25','Week 26','Week 27','Week 28','Week 29','Week 30','Week 31','Week 32','Week 33','Week 34','Week 35','Week 36','Week 37','Week 38','Week 39','Week 40','Week 41','Week 42','Week 43','Week 44','Week 45','Week 46','Week 47','Week 48','Week 49','Week 50','Week 51','Week 52'],
        monthly2024: [3149650,2951532,2672523,3168222,3665044,4106213,3855478,3975836,4026113,4506508],
        monthly2025: [4229949.74,4137314.91,3255914.40,4160183.10,4547728.40,4766683.46,4776431.60,4588791.00,4447282.47,5730046.85],
        weekly2024: [
          787412, 737883, 668131, 792056, 916261, 1026553, 963870, 993959, 1006528, 1126627
        ],
        weekly2025: [
          1057487, 1034329, 813979, 1040046, 1136932, 1191671, 1194108, 1147198, 1111821, 1432512
        ],
        branches: [
          {name:'All', totals2024:36077119, totals2025:44232732, channels:{}},
          {name:'Hamdan St', totals2024:8297881, totals2025:7444537, channels:{'Self Delivery':1071066,'Online Web':340571,'Noon':881574,'Careem':787018,'Smile':347071,'Deliveroo':17500,'Talabat':472809,'Keeta':22559,'Talabana':0}, channels2024:{'Self Delivery':1326880,'Online Web':337791,'Noon':921626,'Careem':114142,'Smile':418980,'Deliveroo':97537,'Talabat':1019864,'Keeta':0,'Talabana':4752}},
          {name:'Khaldia', totals2024:6293740, totals2025:6039662, channels:{'Self Delivery':544674,'Online Web':166283,'Noon':866887,'Careem':649836,'Smile':258092,'Deliveroo':129299,'Talabat':639701,'Keeta':21671,'Talabana':93}, channels2024:{'Self Delivery':673137,'Online Web':193287,'Noon':828151,'Careem':95050,'Smile':243034,'Deliveroo':100185,'Talabat':1091298,'Keeta':0,'Talabana':8607}},
          {name:'Shabiya 11', totals2024:5502957, totals2025:6510384, channels:{'Self Delivery':542192,'Online Web':109025,'Noon':1215220,'Careem':631148,'Smile':469551,'Deliveroo':34565,'Talabat':455058,'Keeta':29489,'Talabana':0}, channels2024:{'Self Delivery':578016,'Online Web':100568,'Noon':781361,'Careem':65129,'Smile':500450,'Deliveroo':43854,'Talabat':603309,'Keeta':0,'Talabana':0}},
          {name:'Muroor', totals2024:4767127, totals2025:5125737, channels:{'Self Delivery':526013,'Online Web':54375,'Noon':642018,'Careem':505132,'Smile':212537,'Deliveroo':37345,'Talabat':444659,'Keeta':18125,'Talabana':35}, channels2024:{'Self Delivery':604208,'Online Web':87023,'Noon':468515,'Careem':64580,'Smile':216136,'Deliveroo':45507,'Talabat':668358,'Keeta':0,'Talabana':5334}},
          {name:'Elctria', totals2024:2830175, totals2025:7637929, channels:{'Self Delivery':0,'Online Web':0,'Noon':1050830,'Careem':824947,'Smile':267675,'Deliveroo':0,'Talabat':595703,'Keeta':23083,'Talabana':0}, channels2024:{'Self Delivery':0,'Online Web':0,'Noon':381501,'Careem':21497,'Smile':114956,'Deliveroo':0,'Talabat':16268,'Keeta':0,'Talabana':0}},
          {name:'Al Barsha', totals2024:5753883, totals2025:6257407, channels:{'Self Delivery':471474,'Online Web':80432,'Noon':921495,'Careem':586725,'Smile':281113,'Deliveroo':65944,'Talabat':448314,'Keeta':183597,'Talabana':0}, channels2024:{'Self Delivery':455337,'Online Web':148375,'Noon':808082,'Careem':442207,'Smile':186627,'Deliveroo':71914,'Talabat':613353,'Keeta':0,'Talabana':18412}},
          {name:'Al Satwa', totals2024:2631356, totals2025:4774601, channels:{'Self Delivery':226919,'Online Web':121494,'Noon':916518,'Careem':455961,'Smile':231975,'Deliveroo':23611,'Talabat':397797,'Keeta':185251,'Talabana':0}, channels2024:{'Self Delivery':168430,'Online Web':45520,'Noon':289434,'Careem':147407,'Smile':0,'Deliveroo':8165,'Talabat':123450,'Keeta':0,'Talabana':7038}},
          {name:'Al Rigga', totals2024:0, totals2025:442475, channels:{'Self Delivery':16628,'Online Web':2076,'Noon':120813,'Careem':6256,'Smile':8513,'Deliveroo':876,'Talabat':0,'Keeta':287238,'Talabana':75}, channels2024:{'Self Delivery':0,'Online Web':0,'Noon':0,'Careem':0,'Smile':0,'Deliveroo':0,'Talabat':0,'Keeta':0,'Talabana':0}},
          {name:'Al Sharja', totals2024:0, totals2025:0, channels:{'Self Delivery':0,'Online Web':0,'Noon':0,'Careem':0,'Smile':0,'Deliveroo':0,'Talabat':0,'Keeta':0,'Talabana':0}, channels2024:{'Self Delivery':0,'Online Web':0,'Noon':0,'Careem':0,'Smile':0,'Deliveroo':0,'Talabat':0,'Keeta':0,'Talabana':0}}
        ]
      };

      // Application State
      let currentTab = 'overview';
      let currentYear = '2025';
      let currentBranch = 'all';
      let currentPeriod = 'monthly';
      let editMode = false;
      let charts = {};

      // Create a deep copy of original data for reset
      const originalData = JSON.parse(JSON.stringify(DATA));

      // Utility Functions
      function formatNumber(num) {
        if (num === 0) return '0';
        const n = Number(num) || 0;
        if (Math.abs(n) >= 1000000) return (n / 1000000).toFixed(2) + 'M';
        if (Math.abs(n) >= 1000) return Math.round(n / 1000) + 'k';
        return String(n);
      }

      function parseFormattedValue(formattedValue) {
        // Remove formatting and convert to number
        if (typeof formattedValue !== 'string') return Number(formattedValue) || 0;
        
        let value = formattedValue.replace(/,/g, '');
        
        if (value.includes('M')) {
          return parseFloat(value) * 1000000;
        } else if (value.includes('k')) {
          return parseFloat(value) * 1000;
        }
        
        return parseFloat(value) || 0;
      }

      function calculateGrowth(a, b) {
        const denom = Math.abs(Number(a)) || 1;
        return ((Number(b) - Number(a)) / denom) * 100;
      }

      function calculateWeeklyAverage(total) {
        return total / 52; // 52 weeks in a year
      }

      function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.style.background = type === 'success' ? 'var(--success)' : 'var(--danger)';
        notification.classList.add('show');
        
        setTimeout(() => {
          notification.classList.remove('show');
        }, 3000);
      }

      // Initialize Branch Selector
      function initializeBranchSelector() {
        const branchFilter = document.getElementById('branchFilter');
        const channelBranchSelect = document.getElementById('channelBranchSelect');
        
        DATA.branches.slice(1).forEach(branch => {
          const option = document.createElement('option');
          option.value = branch.name;
          option.textContent = branch.name;
          branchFilter.appendChild(option);
          
          const option2 = document.createElement('option');
          option2.value = branch.name;
          option2.textContent = branch.name;
          channelBranchSelect.appendChild(option2);
        });
      }

      // Tab Navigation
      function initializeTabs() {
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
          button.addEventListener('click', () => {
            const tabName = button.dataset.tab;
            
            // Update active states
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            button.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            currentTab = tabName;
            renderCurrentTab();
          });
        });
      }

      // Edit Mode Functions
      function enableEditMode() {
        editMode = true;
        document.getElementById('editBtn').textContent = '‚úì Save Mode';
        document.getElementById('editBtn').classList.add('success');
        document.getElementById('editBtn').classList.remove('warning');
        
        // Show edit containers based on current tab
        if (currentTab === 'overview') {
          document.getElementById('editTableContainer').style.display = 'block';
          document.getElementById('total2024').classList.add('edit-mode');
          document.getElementById('total2025').classList.add('edit-mode');
          document.getElementById('total2024').contentEditable = true;
          document.getElementById('total2025').contentEditable = true;
          
          // Populate edit values
          const allBranch = DATA.branches[0];
          document.getElementById('editTotal2024').value = allBranch.totals2024;
          document.getElementById('editTotal2025').value = allBranch.totals2025;
        } else if (currentTab === 'branches') {
          document.getElementById('branchEditContainer').style.display = 'block';
          populateBranchEditTable();
        } else if (currentTab === 'channels') {
          document.getElementById('channelEditContainer').style.display = 'block';
          populateChannelEditTable();
        }
        
        // Disable chart interactions
        Object.keys(charts).forEach(key => {
          if (charts[key] && charts[key].options) {
            charts[key].options.onClick = null;
          }
        });
      }

      function disableEditMode() {
        editMode = false;
        document.getElementById('editBtn').textContent = '‚úèÔ∏è Edit Data';
        document.getElementById('editBtn').classList.add('warning');
        document.getElementById('editBtn').classList.remove('success');
        
        // Hide all edit containers
        document.getElementById('editTableContainer').style.display = 'none';
        document.getElementById('branchEditContainer').style.display = 'none';
        document.getElementById('channelEditContainer').style.display = 'none';
        
        // Disable contentEditable
        document.getElementById('total2024').classList.remove('edit-mode');
        document.getElementById('total2025').classList.remove('edit-mode');
        document.getElementById('total2024').contentEditable = false;
        document.getElementById('total2025').contentEditable = false;
        
        // Re-enable chart interactions
        renderCurrentTab();
      }

      function saveTotalChanges() {
        const total2024 = Number(document.getElementById('editTotal2024').value) || 0;
        const total2025 = Number(document.getElementById('editTotal2025').value) || 0;
        
        // Update "All" branch totals
        DATA.branches[0].totals2024 = total2024;
        DATA.branches[0].totals2025 = total2025;
        
        disableEditMode();
        renderCurrentTab();
        showNotification('Total sales data saved successfully!');
      }

      function saveBranchChanges() {
        const inputs = document.querySelectorAll('#branchEditTable input');
        inputs.forEach(input => {
          const branchIndex = parseInt(input.dataset.branchIndex);
          const year = input.dataset.year;
          const value = Number(input.value) || 0;
          
          if (year === '2024') {
            DATA.branches[branchIndex].totals2024 = value;
          } else {
            DATA.branches[branchIndex].totals2025 = value;
          }
        });
        
        // Update "All" branch totals
        updateAllBranchTotals();
        
        disableEditMode();
        renderCurrentTab();
        showNotification('Branch data saved successfully!');
      }

      function saveChannelChanges() {
        const selectedBranch = document.getElementById('channelBranchSelect').value;
        const branchIndex = selectedBranch === 'all' ? 0 : 
          DATA.branches.findIndex(b => b.name === selectedBranch);
        
        if (branchIndex === 0) {
          showNotification('Cannot edit "All" branch channel data. Please select a specific branch.', 'danger');
          return;
        }
        
        const inputs = document.querySelectorAll('#channelEditTable input');
        inputs.forEach(input => {
          const channel = input.dataset.channel;
          const year = input.dataset.year;
          const value = Number(input.value) || 0;
          
          if (year === '2024') {
            if (!DATA.branches[branchIndex].channels2024) {
              DATA.branches[branchIndex].channels2024[channel] = value;
            }
          } else {
            DATA.branches[branchIndex].channels[channel] = value;
          }
        });
        
        // Recalculate branch totals
        recalculateBranchTotals(branchIndex);
        
        // Update "All" branch totals
        updateAllBranchTotals();
        
        disableEditMode();
        renderCurrentTab();
        showNotification('Channel data saved successfully!');
      }

      function populateBranchEditTable() {
        const tbody = document.querySelector('#branchEditTable tbody');
        tbody.innerHTML = '';
        
        DATA.branches.slice(1).forEach((branch, index) => {
          const row = document.createElement('tr');
          const avgWeekly2024 = calculateWeeklyAverage(branch.totals2024);
          const avgWeekly2025 = calculateWeeklyAverage(branch.totals2025);
          
          row.innerHTML = `
            <td>${branch.name}</td>
            <td><input type="number" data-branch-index="${index+1}" data-year="2024" value="${branch.totals2024}" class="edit-input"></td>
            <td><input type="number" data-branch-index="${index+1}" data-year="2025" value="${branch.totals2025}" class="edit-input"></td>
            <td><input type="number" data-branch-index="${index+1}" data-year="avg2024" value="${avgWeekly2024}" class="edit-input" disabled></td>
            <td><input type="number" data-branch-index="${index+1}" data-year="avg2025" value="${avgWeekly2025}" class="edit-input" disabled></td>
          `;
          tbody.appendChild(row);
        });
      }

      function populateChannelEditTable() {
        const selectedBranch = document.getElementById('channelBranchSelect').value;
        const branchIndex = selectedBranch === 'all' ? 0 : 
          DATA.branches.findIndex(b => b.name === selectedBranch);
        
        if (branchIndex === 0) {
          document.querySelector('#channelEditTable tbody').innerHTML = 
            '<tr><td colspan="4" style="text-align: center;">Please select a specific branch to edit channel data.</td></tr>';
          return;
        }
        
        const branch = DATA.branches[branchIndex];
        const tbody = document.querySelector('#channelEditTable tbody');
        tbody.innerHTML = '';
        
        Object.keys(branch.channels).forEach(channel => {
          const row = document.createElement('tr');
          const value2024 = branch.channels2024 ? branch.channels2024[channel] || 0 : 0;
          const value2025 = branch.channels[channel] || 0;
          const avgWeekly2024 = calculateWeeklyAverage(value2024);
          const avgWeekly2025 = calculateWeeklyAverage(value2025);
          
          row.innerHTML = `
            <td>${channel}</td>
            <td><input type="number" data-channel="${channel}" data-year="2024" value="${value2024}" class="edit-input"></td>
            <td><input type="number" data-channel="${channel}" data-year="2025" value="${value2025}" class="edit-input"></td>
            <td><input type="number" data-channel="${channel}" data-year="avg2024" value="${avgWeekly2024}" class="edit-input" disabled></td>
            <td><input type="number" data-channel="${channel}" data-year="avg2025" value="${avgWeekly2025}" class="edit-input" disabled></td>
          `;
          tbody.appendChild(row);
        });
      }

      function recalculateBranchTotals(branchIndex) {
        const branch = DATA.branches[branchIndex];
        let total2024 = 0;
        let total2025 = 0;
        
        Object.keys(branch.channels).forEach(channel => {
          total2024 += branch.channels2024 ? branch.channels2024[channel] || 0 : 0;
          total2025 += branch.channels[channel] || 0;
        });
        
        branch.totals2024 = total2024;
        branch.totals2025 = total2025;
      }

      function updateAllBranchTotals() {
        let total2024 = 0;
        let total2025 = 0;
        
        for (let i = 1; i < DATA.branches.length; i++) {
          total2024 += DATA.branches[i].totals2024;
          total2025 += DATA.branches[i].totals2025;
        }
        
        DATA.branches[0].totals2024 = total2024;
        DATA.branches[0].totals2025 = total2025;
      }

      function resetData() {
        // Reset to original data
        for (let i = 0; i < DATA.branches.length; i++) {
          DATA.branches[i] = JSON.parse(JSON.stringify(originalData.branches[i]));
        }
        
        disableEditMode();
        renderCurrentTab();
        showNotification('Data reset to original values!');
      }

      // Executive Overview Functions
      function renderExecutiveOverview() {
        renderYearComparison();
        renderKPIs();
        renderTrendChart();
        renderBranchDistribution();
        renderChannelOverview();
      }

      function renderYearComparison() {
        const allBranch = DATA.branches[0];
        document.getElementById('total2024').textContent = formatNumber(allBranch.totals2024);
        document.getElementById('total2025').textContent = formatNumber(allBranch.totals2025);
        
        const growth = calculateGrowth(allBranch.totals2024, allBranch.totals2025);
        const growthArrow = document.getElementById('growthArrow');
        const growthRateEl = document.getElementById('growthRate');
        
        growthArrow.textContent = growth >= 0 ? 'üîº' : 'üîª';
        growthRateEl.textContent = Math.abs(growth).toFixed(1) + '%';
        growthRateEl.className = growth >= 0 ? 'kpi-change positive' : 'kpi-change negative';
      }

      function renderKPIs() {
        const year = currentYear;
        const prevYear = year === '2025' ? '2024' : '2025';
        const totalKey = `totals${year}`;
        const prevTotalKey = `totals${prevYear}`;
        
        // Calculate totals
        let totalSales = 0;
        let prevTotalSales = 0;
        let topBranch = null;
        let topChannel = {};
        
        DATA.branches.slice(1).forEach(branch => {
          totalSales += branch[totalKey];
          prevTotalSales += branch[prevTotalKey];
          
          if (!topBranch || branch[totalKey] > topBranch[totalKey]) {
            topBranch = branch;
          }
          
          Object.keys(branch.channels).forEach(channel => {
            if (!topChannel[channel] || branch.channels[channel] > topChannel[channel]) {
              topChannel[channel] = branch.channels[channel];
            }
          });
        });

        const growth = calculateGrowth(prevTotalSales, totalSales);
        const topChannelName = Object.keys(topChannel).reduce((a, b) => 
          topChannel[a] > topChannel[b] ? a : b, '');

        // Calculate average weekly
        const avgWeekly = calculateWeeklyAverage(totalSales);
        const prevAvgWeekly = calculateWeeklyAverage(prevTotalSales);
        const avgWeeklyGrowth = calculateGrowth(prevAvgWeekly, avgWeekly);

        // Find peak period
        const dataKey = currentPeriod === 'monthly' ? `monthly${year}` : `weekly${year}`;
        const periodData = DATA[dataKey];
        const maxValue = Math.max(...periodData);
        const peakIndex = periodData.indexOf(maxValue);
        const peakPeriod = currentPeriod === 'monthly' ? DATA.months[peakIndex] : `Week ${peakIndex + 1}`;

        // Update KPI cards
        document.getElementById('topBranch').textContent = topBranch ? topBranch.name : '-';
        document.getElementById('topChannel').textContent = topChannelName || '-';
        document.getElementById('avgWeekly').textContent = formatNumber(avgWeekly);
        
        // Update change indicators
        updateChangeIndicator('topBranchChange', calculateGrowth(topBranch[prevTotalKey], topBranch[totalKey]));
        updateChangeIndicator('topChannelChange', calculateGrowth(topChannel[topChannelName] || 0, topChannelName ? topChannel[topChannelName] : 0));
        updateChangeIndicator('avgWeeklyChange', avgWeeklyGrowth);
        updateChangeIndicator('peakPeriodChange', 0); // No previous data for comparison
        
        // Update peak period
        document.getElementById('peakPeriod').textContent = peakPeriod;
      }

      function updateChangeIndicator(elementId, value) {
        const element = document.getElementById(elementId);
        const isPositive = value >= 0;
        element.textContent = (isPositive ? 'üîº' : 'üîª') + ' ' + Math.abs(value).toFixed(1) + '%';
        element.className = 'kpi-change ' + (isPositive ? 'positive' : 'negative');
      }

      function renderTrendChart() {
        const ctx = document.getElementById('trendChart').getContext('2d');
        
        if (charts.trend) {
          charts.trend.destroy();
        }

        const dataKey = currentPeriod === 'monthly' ? `monthly${currentYear}` : `weekly${currentYear}`;
        const labels = currentPeriod === 'monthly' ? DATA.months : DATA.weeks;
        const data = DATA[dataKey];
        
        charts.trend = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: `${currentYear} Sales`,
              data: data,
              borderColor: '#3b82f6',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              borderWidth: 2,
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context) => `Sales: ${formatNumber(context.raw)}`
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: formatNumber
                }
              }
            }
          }
        });
      }

      function renderBranchDistribution() {
        const ctx = document.getElementById('branchDistChart').getContext('2d');
        
        if (charts.branchDist) {
          charts.branchDist.destroy();
        }

        const totalKey = `totals${currentYear}`;
        const branchData = DATA.branches.slice(1).map(branch => ({
          name: branch.name,
          value: branch[totalKey]
        }));

        charts.branchDist = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: branchData.map(b => b.name),
            datasets: [{
              data: branchData.map(b => b.value),
              backgroundColor: [
                '#3b82f6', '#10b981', '#f59e0b', '#ef4444',
                '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'
              ]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'right'
              },
              tooltip: {
                callbacks: {
                  label: (context) => `${context.label}: ${formatNumber(context.raw)}`
                }
              }
            }
          }
        });
      }

      function renderChannelOverview() {
        const ctx = document.getElementById('channelOverviewChart').getContext('2d');
        
        if (charts.channelOverview) {
          charts.channelOverview.destroy();
        }

        const channelTotals = {};
        DATA.branches.slice(1).forEach(branch => {
          Object.keys(branch.channels).forEach(channel => {
            channelTotals[channel] = (channelTotals[channel] || 0) + branch.channels[channel];
          });
        });

        const sortedChannels = Object.entries(channelTotals).sort((a, b) => b[1] - a[1]);

        charts.channelOverview = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: sortedChannels.map(c => c[0]),
            datasets: [{
              label: `${currentYear} Sales`,
              data: sortedChannels.map(c => c[1]),
              backgroundColor: 'rgba(59, 130, 246, 0.8)',
              borderColor: '#3b82f6',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context) => `Sales: ${formatNumber(context.raw)}`
                }
              }
            },
            scales: {
              x: {
                beginAtZero: true,
                ticks: {
                  callback: formatNumber
                }
              }
            }
          }
        });
      }

      // Branch Comparison Functions
      function renderBranchComparison() {
        renderBranchComparisonChart();
        renderBranchTable();
      }

      function renderBranchComparisonChart() {
        const ctx = document.getElementById('branchComparisonChart').getContext('2d');
        
        if (charts.branchComparison) {
          charts.branchComparison.destroy();
        }

        const branchData = DATA.branches.slice(1);
        
        charts.branchComparison = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: branchData.map(b => b.name),
            datasets: [
              {
                label: '2024',
                data: branchData.map(b => b.totals2024),
                backgroundColor: 'rgba(156, 163, 175, 0.8)',
                borderColor: '#9ca3af',
                borderWidth: 1
              },
              {
                label: '2025',
                data: branchData.map(b => b.totals2025),
                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                borderColor: '#3b82f6',
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'top' },
              tooltip: {
                callbacks: {
                  label: (context) => `${context.dataset.label}: ${formatNumber(context.raw)}`
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: formatNumber
                }
              }
            }
          }
        });
      }

      function renderBranchTable() {
        const tbody = document.querySelector('#branchTable tbody');
        tbody.innerHTML = '';

        const branchData = DATA.branches.slice(1).map(branch => {
          const growth = calculateGrowth(branch.totals2024, branch.totals2025);
          const avgWeekly = calculateWeeklyAverage(branch[`totals${currentYear}`]);
          const topChannel = Object.keys(branch.channels).reduce((a, b) => 
            branch.channels[a] > branch.channels[b] ? a : b
          , '');

          return {
            name: branch.name,
            total2024: branch.totals2024,
            total2025: branch.totals2025,
            growth: growth,
            topChannel: topChannel,
            avgWeekly: avgWeekly
          };
        });

        branchData.forEach(branch => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${branch.name}</td>
            <td>${formatNumber(branch.total2024)}</td>
            <td>${formatNumber(branch.total2025)}</td>
            <td><span class="${branch.growth >= 0 ? 'positive' : 'negative'}">${branch.growth.toFixed(1)}%</span></td>
            <td>${branch.topChannel}</td>
            <td>${formatNumber(branch.avgWeekly)}</td>
          `;
          tbody.appendChild(row);
        });

        // Add sorting functionality
        initializeTableSorting('branchTable');
      }

      // Channel Performance Functions
      function renderChannelPerformance() {
        renderChannelYearChart();
        renderChannelGrowthChart();
        renderChannelBranchChart();
        renderChannelTable();
      }

      function renderChannelYearChart() {
        const ctx = document.getElementById('channelYearChart').getContext('2d');
        
        if (charts.channelYear) {
          charts.channelYear.destroy();
        }

        const channelTotals2024 = {};
        const channelTotals2025 = {};
        
        DATA.branches.slice(1).forEach(branch => {
          Object.keys(branch.channels).forEach(channel => {
            channelTotals2024[channel] = (channelTotals2024[channel] || 0) + (branch.channels2024?.[channel] || 0);
            channelTotals2025[channel] = (channelTotals2025[channel] || 0) + branch.channels[channel];
          });
        });

        const channels = Object.keys(channelTotals2025);
        
        charts.channelYear = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: channels,
            datasets: [
              {
                label: '2024',
                data: channels.map(c => channelTotals2024[c]),
                backgroundColor: 'rgba(156, 163, 175, 0.8)',
                borderColor: '#9ca3af',
                borderWidth: 1
              },
              {
                label: '2025',
                data: channels.map(c => channelTotals2025[c]),
                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                borderColor: '#3b82f6',
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'top' },
              tooltip: {
                callbacks: {
                  label: (context) => `${context.dataset.label}: ${formatNumber(context.raw)}`
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: formatNumber
                }
              }
            }
          }
        });
      }

      function renderChannelGrowthChart() {
        const ctx = document.getElementById('channelGrowthChart').getContext('2d');
        
        if (charts.channelGrowth) {
          charts.channelGrowth.destroy();
        }

        const channelGrowth = {};
        DATA.branches.slice(1).forEach(branch => {
          Object.keys(branch.channels).forEach(channel => {
            const val2024 = branch.channels2024?.[channel] || 0;
            const val2025 = branch.channels[channel];
            if (val2024 > 0) {
              channelGrowth[channel] = calculateGrowth(val2024, val2025);
            }
          });
        });

        const sortedGrowth = Object.entries(channelGrowth)
          .filter(([_, growth]) => isFinite(growth))
          .sort((a, b) => b[1] - a[1]);

        charts.channelGrowth = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: sortedGrowth.map(c => c[0]),
            datasets: [{
              label: 'Growth %',
              data: sortedGrowth.map(c => c[1]),
              backgroundColor: sortedGrowth.map(c => 
                c[1] >= 0 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)'
              ),
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context) => `Growth: ${context.raw.toFixed(1)}%`
                }
              }
            },
            scales: {
              y: {
                ticks: {
                  callback: (value) => value + '%'
                }
              }
            }
          }
        });
      }

      function renderChannelBranchChart() {
        const ctx = document.getElementById('channelBranchChart').getContext('2d');
        
        if (charts.channelBranch) {
          charts.channelBranch.destroy();
        }

        const branches = currentBranch === 'all' 
          ? DATA.branches.slice(1)
          : DATA.branches.filter(b => b.name === currentBranch);

        const channels = ['Self Delivery', 'Online Web', 'Noon', 'Careem', 'Smile', 'Deliveroo', 'Talabat', 'Keeta', 'Talabana'];
        const datasets = channels.map((channel, index) => {
          const colors = [
            'rgba(59, 130, 246, 0.8)', 'rgba(16, 185, 129, 0.8)', 
            'rgba(245, 158, 11, 0.8)', 'rgba(239, 68, 68, 0.8)',
            'rgba(139, 92, 246, 0.8)', 'rgba(236, 72, 153, 0.8)',
            'rgba(6, 182, 212, 0.8)', 'rgba(132, 204, 22, 0.8)'
          ];

          return {
            label: channel,
            data: branches.map(b => b.channels[channel] || 0),
            backgroundColor: colors[index % colors.length],
            borderWidth: 1
          };
        });

        charts.channelBranch = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: branches.map(b => b.name),
            datasets: datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'top' },
              tooltip: {
                callbacks: {
                  label: (context) => `${context.dataset.label}: ${formatNumber(context.raw)}`
                }
              }
            },
            scales: {
              x: { stacked: true },
              y: { 
                stacked: true,
                ticks: {
                  callback: formatNumber
                }
              }
            }
          }
        });
      }

      function renderChannelTable() {
        const tbody = document.querySelector('#channelTable tbody');
        tbody.innerHTML = '';

        const channelTotals2024 = {};
        const channelTotals2025 = {};
        const channelTopBranch = {};
        
        DATA.branches.slice(1).forEach(branch => {
          Object.keys(branch.channels).forEach(channel => {
            const val2024 = branch.channels2024?.[channel] || 0;
            const val2025 = branch.channels[channel];
            
            channelTotals2024[channel] = (channelTotals2024[channel] || 0) + val2024;
            channelTotals2025[channel] = (channelTotals2025[channel] || 0) + val2025;
            
            if (!channelTopBranch[channel] || val2025 > channelTopBranch[channel].value) {
              channelTopBranch[channel] = { branch: branch.name, value: val2025 };
            }
          });
        });

        const channels = Object.keys(channelTotals2025);
        
        channels.forEach(channel => {
          const growth = calculateGrowth(channelTotals2024[channel], channelTotals2025[channel]);
          const avgWeekly = calculateWeeklyAverage(channelTotals2025[channel]);
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${channel}</td>
            <td>${formatNumber(channelTotals2024[channel])}</td>
            <td>${formatNumber(channelTotals2025[channel])}</td>
            <td><span class="${growth >= 0 ? 'positive' : 'negative'}">${growth.toFixed(1)}%</span></td>
            <td>${channelTopBranch[channel]?.branch || '-'}</td>
            <td>${formatNumber(avgWeekly)}</td>
          `;
          tbody.appendChild(row);
        });

        // Add sorting functionality
        initializeTableSorting('channelTable');
      }

      // Table Sorting
      function initializeTableSorting(tableId) {
        const table = document.getElementById(tableId);
        const headers = table.querySelectorAll('.sortable');
        
        headers.forEach(header => {
          header.addEventListener('click', () => {
            const sortKey = header.dataset.sort;
            const currentClass = header.className;
            
            // Remove all sort classes
            headers.forEach(h => h.className = 'sortable');
            
            // Determine sort direction
            const isAsc = currentClass.includes('asc');
            header.className = `sortable ${isAsc ? 'desc' : 'asc'}`;
            
            // Sort and re-render table
            if (tableId === 'branchTable') {
              sortBranchTable(sortKey, !isAsc);
            } else if (tableId === 'channelTable') {
              sortChannelTable(sortKey, !isAsc);
            }
          });
        });
      }

      function sortBranchTable(sortKey, asc) {
        const tbody = document.querySelector('#branchTable tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        rows.sort((a, b) => {
          let aVal, bVal;
          
          switch(sortKey) {
            case 'name':
              aVal = a.cells[0].textContent;
              bVal = b.cells[0].textContent;
              break;
            case '2024':
              aVal = parseFloat(a.cells[1].textContent.replace(/[^0-9.-]/g, ''));
              bVal = parseFloat(b.cells[1].textContent.replace(/[^0-9.-]/g, ''));
              break;
            case '2025':
              aVal = parseFloat(a.cells[2].textContent.replace(/[^0-9.-]/g, ''));
              bVal = parseFloat(b.cells[2].textContent.replace(/[^0-9.-]/g, ''));
              break;
            case 'growth':
              aVal = parseFloat(a.cells[3].textContent);
              bVal = parseFloat(b.cells[3].textContent);
              break;
            case 'channel':
              aVal = a.cells[4].textContent;
              bVal = b.cells[4].textContent;
              break;
            case 'weekly':
              aVal = parseFloat(a.cells[5].textContent.replace(/[^0-9.-]/g, ''));
              bVal = parseFloat(b.cells[5].textContent.replace(/[^0-9.-]/g, ''));
              break;
          }
          
          if (typeof aVal === 'string') {
            return asc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
          }
          return asc ? aVal - bVal : bVal - aVal;
        });
        
        tbody.innerHTML = '';
        rows.forEach(row => tbody.appendChild(row));
      }

      function sortChannelTable(sortKey, asc) {
        const tbody = document.querySelector('#channelTable tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        rows.sort((a, b) => {
          let aVal, bVal;
          
          switch(sortKey) {
            case 'channel':
              aVal = a.cells[0].textContent;
              bVal = b.cells[0].textContent;
              break;
            case '2024':
              aVal = parseFloat(a.cells[1].textContent.replace(/[^0-9.-]/g, ''));
              bVal = parseFloat(b.cells[1].textContent.replace(/[^0-9.-]/g, ''));
              break;
            case '2025':
              aVal = parseFloat(a.cells[2].textContent.replace(/[^0-9.-]/g, ''));
              bVal = parseFloat(b.cells[2].textContent.replace(/[^0-9.-]/g, ''));
              break;
            case 'growth':
              aVal = parseFloat(a.cells[3].textContent);
              bVal = parseFloat(b.cells[3].textContent);
              break;
            case 'branch':
              aVal = a.cells[4].textContent;
              bVal = b.cells[4].textContent;
              break;
            case 'weekly':
              aVal = parseFloat(a.cells[5].textContent.replace(/[^0-9.-]/g, ''));
              bVal = parseFloat(b.cells[5].textContent.replace(/[^0-9.-]/g, ''));
              break;
          }
          
          if (typeof aVal === 'string') {
            return asc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
          }
          return asc ? aVal - bVal : bVal - aVal;
        });
        
        tbody.innerHTML = '';
        rows.forEach(row => tbody.appendChild(row));
      }

      // Export Function
      function exportToCSV() {
        let csv = '';
        
        if (currentTab === 'overview') {
          csv = 'Executive Overview Export\n';
          csv += `Year,${currentYear}\n`;
          csv += `Period,${currentPeriod}\n`;
          csv += `Total Sales,${formatNumber(DATA.branches[0][`totals${currentYear}`])}\n`;
        } else if (currentTab === 'branches') {
          csv = 'Branch Comparison Export\n';
          csv += 'Branch,2024 Sales,2025 Sales,Growth %,Avg Weekly\n';
          DATA.branches.slice(1).forEach(branch => {
            const growth = calculateGrowth(branch.totals2024, branch.totals2025);
            const avgWeekly = calculateWeeklyAverage(branch[`totals${currentYear}`]);
            csv += `${branch.name},${branch.totals2024},${branch.totals2025},${growth.toFixed(1)}%,${formatNumber(avgWeekly)}\n`;
          });
        } else if (currentTab === 'channels') {
          csv = 'Channel Performance Export\n';
          csv += 'Channel,2024 Sales,2025 Sales,Growth %,Avg Weekly,Top Branch\n';
          
          const channelTotals2024 = {};
          const channelTotals2025 = {};
          const channelTopBranch = {};
          
          DATA.branches.slice(1).forEach(branch => {
            Object.keys(branch.channels).forEach(channel => {
              const val2024 = branch.channels2024?.[channel] || 0;
              const val2025 = branch.channels[channel];
              
              channelTotals2024[channel] = (channelTotals2024[channel] || 0) + val2024;
              channelTotals2025[channel] = (channelTotals2025[channel] || 0) + val2025;
              
              if (!channelTopBranch[channel] || val2025 > channelTopBranch[channel].value) {
                channelTopBranch[channel] = { branch: branch.name, value: val2025 };
              }
            });
          });
          
          Object.keys(channelTotals2025).forEach(channel => {
            const growth = calculateGrowth(channelTotals2024[channel], channelTotals2025[channel]);
            const avgWeekly = calculateWeeklyAverage(channelTotals2025[channel]);
            csv += `${channel},${channelTotals2024[channel]},${channelTotals2025[channel]},${growth.toFixed(1)}%,${formatNumber(avgWeekly)},${channelTopBranch[channel]?.branch || '-'}\n`;
          });
        }
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `crispy_chicken_${currentTab}_${currentYear}_${currentPeriod}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        
        showNotification('Data exported successfully!');
      }

      // Render Current Tab
      function renderCurrentTab() {
        // Update period label
        document.getElementById('periodLabel').textContent = currentPeriod === 'monthly' ? 'Monthly' : 'Weekly';
        
        switch(currentTab) {
          case 'overview':
            renderExecutiveOverview();
            break;
          case 'branches':
            renderBranchComparison();
            break;
          case 'channels':
            renderChannelPerformance();
            break;
        }
      }

      // Event Listeners
      function initializeEventListeners() {
        // Edit mode toggle
        document.getElementById('editBtn').addEventListener('click', () => {
          if (editMode) {
            disableEditMode();
          } else {
            enableEditMode();
          }
        });

        // Reset button
        document.getElementById('resetBtn').addEventListener('click', resetData);

        // Save buttons
        document.getElementById('saveTotalBtn').addEventListener('click', saveTotalChanges);
        document.getElementById('saveBranchBtn').addEventListener('click', saveBranchChanges);
        document.getElementById('saveChannelBtn').addEventListener('click', saveChannelChanges);

        // Cancel buttons
        document.getElementById('cancelEditBtn').addEventListener('click', disableEditMode);
        document.getElementById('cancelBranchEditBtn').addEventListener('click', disableEditMode);
        document.getElementById('cancelChannelEditBtn').addEventListener('click', disableEditMode);

        // Channel branch selector
        document.getElementById('channelBranchSelect').addEventListener('change', (e) => {
          if (editMode) {
            populateChannelEditTable();
          }
        });

        // Year toggle
        document.getElementById('yearToggle').addEventListener('change', (e) => {
          currentYear = e.target.value;
          renderCurrentTab();
        });

        // Period toggle
        document.getElementById('periodToggle').addEventListener('change', (e) => {
          currentPeriod = e.target.value;
          renderCurrentTab();
        });

        // Branch filter
        document.getElementById('branchFilter').addEventListener('change', (e) => {
          currentBranch = e.target.value;
          if (currentTab === 'channels') {
            renderChannelBranchChart();
          }
        });

        // Export button
        document.getElementById('exportBtn').addEventListener('click', exportToCSV);
      }

      // Initialize Application
      function initialize() {
        initializeBranchSelector();
        initializeTabs();
        initializeEventListeners();
        renderCurrentTab();
      }

      // Start the application
      initialize();
    })();
  </script>
</body>
</html>
