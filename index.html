<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Crispy Chicken â€” Pro Dashboard (Enhanced)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --muted:#64748b; --primary:#4f46e5;
      --success:#16a34a; --danger:#dc2626; --glass: rgba(255,255,255,0.6);
      --accent:#e6eefc; --warning:#f59e0b; --info:#3b82f6;
    }
    [data-theme="dark"]{
      --bg:#0b1220; --card:#0f1724; --muted:#9aa9bf; --primary:#7c3aed;
      --success:#10b981; --danger:#fb7185; --glass: rgba(255,255,255,0.04);
      --accent:#0b122666; --warning:#fbbf24; --info:#60a5fa;
    }

    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:var(--muted);transition:background .25s,color .25s}
    .container{max-width:1400px;margin:24px auto;padding:18px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;gap:12px}
    h1{margin:0;font-size:20px;color:var(--primary);font-weight:700}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    select,button,input{padding:8px 12px;border-radius:10px;border:1px solid #cbd5e1;background:var(--card);color:inherit}
    .icon-btn{display:inline-flex;align-items:center;gap:8px;cursor:pointer}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.12);transition:transform .18s,box-shadow .18s}
    .card:hover{transform:translateY(-4px);box-shadow:0 10px 28px rgba(2,6,23,0.16)}
    .kpi{grid-column:span 3;border-left:6px solid var(--primary)}
    .kpi h3{margin:0;font-size:12px;color:var(--muted)}
    .kpi .value{font-size:24px;font-weight:700;margin-top:6px;color:inherit}
    .small{font-size:12px;color:var(--muted)}
    canvas{width:100%!important;max-height:360px}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px;color:inherit}
    th,td{padding:8px;border-bottom:1px solid rgba(0,0,0,0.06);text-align:left}
    th{font-weight:600;color:var(--muted);font-size:12px}
    .up{color:var(--success);font-weight:700}
    .down{color:var(--danger);font-weight:700}
    .controls-right{display:flex;gap:8px;align-items:center}
    .logo-small{width:36px;height:36px;border-radius:8px;box-shadow:inset 0 0 0 1px rgba(0,0,0,0.04);display:inline-block;vertical-align:middle}
    .top-row{display:flex;gap:12px;align-items:center}
    .btn-primary{background:var(--primary);color:white;border:none}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04)}
    .muted-small{font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:8px}
    .center{display:flex;align-items:center;gap:10px}
    
    /* login modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:flex;align-items:center;justify-content:center;z-index:80}
    .modal{background:var(--card);padding:20px;border-radius:12px;min-width:320px;box-shadow:0 12px 40px rgba(2,6,23,0.4)}
    .form-row{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    .small-link{font-size:12px;color:var(--primary);cursor:pointer}
    
    /* responsive */
    @media (max-width:1000px){
      .kpi{grid-column:span 6}
      .grid{grid-template-columns:repeat(6,1fr)}
    }
    @media (max-width:600px){
      header{flex-direction:column;align-items:flex-start;gap:10px}
      .grid{grid-template-columns:repeat(1,1fr)}
      .kpi{grid-column:span 1}
    }
    
    /* subtle animations */
    .fade-in{animation:fadeIn .45s ease both}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
    
    /* Enhanced styles */
    .kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px}
    .kpi-card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 4px 12px rgba(0,0,0,0.08);position:relative;overflow:hidden}
    .kpi-card::before{content:'';position:absolute;top:0;left:0;width:4px;height:100%;background:var(--primary)}
    .kpi-card.success::before{background:var(--success)}
    .kpi-card.danger::before{background:var(--danger)}
    .kpi-card.warning::before{background:var(--warning)}
    .kpi-card.info::before{background:var(--info)}
    .kpi-value{font-size:28px;font-weight:700;margin:8px 0}
    .kpi-label{font-size:14px;color:var(--muted);margin-bottom:4px}
    .kpi-change{display:flex;align-items:center;gap:4px;font-size:12px}
    .kpi-change i{font-size:10px}
    
    .insight-card{background:var(--accent);border-radius:10px;padding:12px;margin-bottom:12px}
    .insight-title{font-weight:600;display:flex;align-items:center;gap:8px;margin-bottom:6px}
    .insight-content{font-size:14px}
    .insight-tag{display:inline-block;background:var(--primary);color:white;padding:2px 8px;border-radius:12px;font-size:11px;margin-left:8px}
    
    .comparison-table{width:100%;border-collapse:collapse;margin-top:10px}
    .comparison-table th{background:var(--accent);font-weight:600;padding:10px;text-align:left}
    .comparison-table td{padding:10px;border-bottom:1px solid rgba(0,0,0,0.06)}
    .comparison-table tr:hover{background:var(--accent)}
    
    .forecast-container{background:var(--accent);border-radius:10px;padding:16px;margin-top:12px}
    .forecast-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .forecast-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(0,0,0,0.06)}
    .forecast-item:last-child{border-bottom:none}
    
    .metric-card{background:var(--card);border-radius:10px;padding:12px;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
    .metric-title{font-weight:600;margin-bottom:8px}
    .metric-value{font-size:24px;font-weight:700;margin-bottom:4px}
    .metric-change{font-size:12px;display:flex;align-items:center;gap:4px}
    
    .tabs{display:flex;gap:8px;margin-bottom:16px;border-bottom:1px solid rgba(0,0,0,0.1)}
    .tab{padding:8px 16px;cursor:pointer;border-bottom:2px solid transparent}
    .tab.active{border-bottom-color:var(--primary);color:var(--primary);font-weight:600}
    
    .notification{position:fixed;bottom:20px;right:20px;padding:12px 20px;background:var(--primary);color:white;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.2);display:none;z-index:1000;max-width:300px}
    .notification.show{display:block}
    .notification.success{background:var(--success)}
    .notification.error{background:var(--danger)}
    .notification.warning{background:var(--warning)}
    
    .export-menu{position:relative;display:inline-block}
    .export-dropdown{position:absolute;top:100%;right:0;background:var(--card);border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);display:none;z-index:50;min-width:180px}
    .export-dropdown.show{display:block}
    .export-dropdown button{display:block;width:100%;text-align:left;padding:10px 16px;border:none;background:transparent;color:inherit;cursor:pointer}
    .export-dropdown button:hover{background:var(--accent)}
    
    .loading{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,0.3);border-radius:50%;border-top-color:white;animation:spin 1s ease-in-out infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    
    /* Add Data Form Styles */
    .add-data-section {
      margin-top: 30px;
      padding: 20px;
      background: var(--accent);
      border-radius: 12px;
    }
    
    .add-data-section h3 {
      margin-top: 0;
      margin-bottom: 20px;
      color: var(--primary);
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .form-group label {
      font-weight: 600;
      font-size: 14px;
      color: var(--muted);
    }
    
    .form-group input,
    .form-group select {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      background: var(--card);
      color: inherit;
      font-size: 14px;
    }
    
    .form-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    
    .btn-secondary {
      background: transparent;
      color: var(--primary);
      border: 1px solid var(--primary);
    }
    
    .btn-secondary:hover {
      background: var(--primary);
      color: white;
    }
    
    .data-preview {
      margin-top: 20px;
      padding: 15px;
      background: var(--card);
      border-radius: 8px;
      border: 1px solid #e6edf3;
    }
    
    .data-preview h4 {
      margin-top: 0;
      margin-bottom: 10px;
      color: var(--primary);
    }
    
    .preview-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #e6edf3;
    }
    
    .preview-item:last-child {
      border-bottom: none;
    }
    
    .preview-label {
      font-weight: 600;
    }
    
    .preview-value {
      color: var(--primary);
    }
    
    /* Channel Performance Styles */
    .channel-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .channel-card {
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      position: relative;
      overflow: hidden;
    }
    
    .channel-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: var(--primary);
    }
    
    .channel-card.success::before {
      background: var(--success);
    }
    
    .channel-card.danger::before {
      background: var(--danger);
    }
    
    .channel-card.warning::before {
      background: var(--warning);
    }
    
    .channel-card.info::before {
      background: var(--info);
    }
    
    .channel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .channel-name {
      font-weight: 600;
      font-size: 16px;
    }
    
    .channel-growth {
      font-size: 14px;
      font-weight: 600;
    }
    
    .channel-growth.positive {
      color: var(--success);
    }
    
    .channel-growth.negative {
      color: var(--danger);
    }
    
    .channel-growth.neutral {
      color: var(--warning);
    }
    
    .channel-metrics {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    
    .channel-metric {
      text-align: center;
    }
    
    .channel-metric-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary);
    }
    
    .channel-metric-label {
      font-size: 12px;
      color: var(--muted);
    }
    
    .channel-progress {
      height: 8px;
      background: var(--accent);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 8px;
    }
    
    .channel-progress-bar {
      height: 100%;
      background: var(--primary);
      border-radius: 4px;
    }
    
    /* Live Activity Feed */
    .activity-feed {
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      max-height: 300px;
      overflow-y: auto;
    }
    
    .activity-feed h3 {
      margin-top: 0;
      margin-bottom: 12px;
      color: var(--primary);
    }
    
    .activity-item {
      display: flex;
      align-items: flex-start;
      padding: 12px 0;
      border-bottom: 1px solid rgba(0,0,0,0.06);
    }
    
    .activity-item:last-child {
      border-bottom: none;
    }
    
    .activity-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      flex-shrink: 0;
    }
    
    .activity-icon.sales {
      background-color: rgba(76, 201, 240, 0.2);
      color: var(--success);
    }
    
    .activity-icon.branch {
      background-color: rgba(67, 97, 238, 0.2);
      color: var(--primary);
    }
    
    .activity-icon.channel {
      background-color: rgba(247, 37, 133, 0.2);
      color: var(--danger);
    }
    
    .activity-content {
      flex-grow: 1;
    }
    
    .activity-title {
      font-weight: 600;
      margin-bottom: 3px;
    }
    
    .activity-time {
      font-size: 0.8rem;
      color: #888;
    }
    
    /* Live Indicator */
    .live-indicator {
      display: inline-flex;
      align-items: center;
      margin-left: 15px;
      font-size: 0.85rem;
    }
    
    .live-dot {
      width: 8px;
      height: 8px;
      background-color: #4cc9f0;
      border-radius: 50%;
      margin-right: 5px;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    /* Progress Bar */
    .progress-container {
      width: 100%;
      background-color: #f0f0f0;
      border-radius: 10px;
      margin: 20px 0;
      display: none;
    }
    
    .progress-bar {
      height: 10px;
      border-radius: 10px;
      background: var(--success);
      width: 0%;
      transition: width 0.3s ease;
    }
    
    /* Last Updated */
    .last-updated {
      text-align: right;
      font-size: 0.85rem;
      color: #888;
      margin-top: 10px;
    }
    
    /* Keyboard shortcuts */
    .shortcuts {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: var(--card);
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      font-size: 12px;
      display: none;
    }
    
    .shortcuts.show {
      display: block;
    }
    
    .shortcut-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }
    
    .shortcut-key {
      background: var(--accent);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
    }
  </style>
</head>
<body data-theme="light">
  <!-- Login Modal -->
  <div id="loginModal" class="modal-backdrop">
    <div class="modal fade-in">
      <h3 style="margin:0 0 8px 0;color:var(--primary)">Welcome â€” Crispy Chicken</h3>
      <div class="form-row">
        <label class="small">Email</label>
        <input id="loginEmail" placeholder="you@company.com" />
      </div>
      <div class="form-row">
        <label class="small">Password</label>
        <input id="loginPass" type="password" placeholder="password" />
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-top:8px">
        <button id="loginBtn" class="btn-primary">Sign in</button>
        <div class="small muted-small">Demo login â€” any credentials accepted</div>
      </div>
    </div>
  </div>

  <div class="container" id="dashboard" style="display: none;">
    <header>
      <div class="top-row">
        <h1>Crispy Chicken â€” Pro Dashboard</h1>
        <div class="muted-small" style="margin-left:8px">Professional Performance â€¢ 2024 vs 2025</div>
        <div class="live-indicator">
          <span class="live-dot"></span>
          <span>Live</span>
        </div>
      </div>

      <div class="controls-right">
        <div class="center">
          <img id="branchLogo" class="logo-small" alt="logo" />
          <select id="branchSelect"></select>
        </div>

        <select id="yearSelect">
          <option value="all">2024 vs 2025</option>
          <option value="2024">2024 Only</option>
          <option value="2025">2025 Only</option>
        </select>

        <div class="export-menu">
          <button id="exportBtn" class="btn-primary">
            <i class="fas fa-download"></i> Export
          </button>
          <div id="exportDropdown" class="export-dropdown">
            <button id="exportCsv"><i class="fas fa-file-csv"></i> Export CSV</button>
            <button id="exportPdf"><i class="fas fa-file-pdf"></i> Export PDF</button>
            <button id="exportExcel"><i class="fas fa-file-excel"></i> Export Excel</button>
            <button id="exportJson"><i class="fas fa-file-code"></i> Export JSON</button>
            <button id="saveImage"><i class="fas fa-image"></i> Save as Image</button>
          </div>
        </div>

        <div class="controls">
          <button id="themeToggle" class="icon-btn" title="Toggle theme (Ctrl+T)">ðŸŒ™</button>
          <button id="resetBtn" title="Reset dashboard (Ctrl+R)">Reset</button>
          <button id="helpBtn" class="icon-btn" title="Keyboard shortcuts (Ctrl+H)">?</button>
        </div>
      </div>
    </header>

    <!-- KPI Cards -->
    <div class="kpi-grid">
      <div class="kpi-card fade-in">
        <div class="kpi-label">Total 2024</div>
        <div class="kpi-value" id="val2024">-</div>
        <div class="kpi-change" id="kpi24sub"></div>
      </div>
      <div class="kpi-card fade-in success">
        <div class="kpi-label">Total 2025</div>
        <div class="kpi-value" id="val2025">-</div>
        <div class="kpi-change" id="kpi25sub"></div>
      </div>
      <div class="kpi-card fade-in info">
        <div class="kpi-label">Growth %</div>
        <div class="kpi-value" id="growthVal">-</div>
        <div class="kpi-change" id="growthSub"></div>
      </div>
      <div class="kpi-card fade-in warning">
        <div class="kpi-label">Best Branch</div>
        <div class="kpi-value" id="bestBranch">-</div>
        <div class="kpi-change" id="bestSub"></div>
      </div>
    </div>

    <div class="progress-container">
      <div class="progress-bar"></div>
    </div>
    
    <div class="last-updated" id="lastUpdated">Last updated: --:--:--</div>

    <!-- Live Activity Feed -->
    <div class="activity-feed">
      <h3>Live Activity Feed</h3>
      <div class="activity-feed-content" id="activityFeedContent">
        <div class="activity-item">
          <div class="activity-icon sales">ðŸ’°</div>
          <div class="activity-content">
            <div class="activity-title">System initialized</div>
            <div>Dashboard loaded successfully</div>
            <div class="activity-time" id="systemTime">--:--:--</div>
          </div>
        </div>
      </div>
    </div>

    <section class="grid">
      <!-- Branch Comparison Chart -->
      <div class="card" style="grid-column:span 12">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <h3 style="margin:0">Branch Comparison</h3>
          <div class="tabs">
            <div class="tab active" data-chart="branch">Revenue</div>
            <div class="tab" data-chart="growth">Growth</div>
            <div class="tab" data-chart="market">Market Share</div>
          </div>
        </div>
        <canvas id="branchChart"></canvas>
      </div>

      <!-- Ranking Chart -->
      <div class="card" style="grid-column:span 6">
        <h3 style="margin:0">Branch Rankings</h3>
        <canvas id="rankChart"></canvas>
      </div>

      <!-- Trend Chart -->
      <div class="card" style="grid-column:span 6">
        <h3 style="margin:0">Monthly Trend</h3>
        <canvas id="trendChart"></canvas>
      </div>

      <!-- Channel Performance -->
      <div class="card" style="grid-column:span 12">
        <h3 style="margin:0">Channel Performance</h3>
        <div class="channel-grid" id="channelGrid">
          <!-- Channel cards will be dynamically generated -->
        </div>
      </div>

      <!-- Insights Section -->
      <div class="card" style="grid-column:span 6">
        <h3 style="margin:0">Key Insights</h3>
        <div id="insightsContainer">
          <div class="insight-card">
            <div class="insight-title">
              <i class="fas fa-lightbulb"></i> Loading insights...
              <span class="insight-tag">Analyzing</span>
            </div>
            <div class="insight-content">Please wait while we analyze your data</div>
          </div>
        </div>
        <button id="generateInsights" class="btn-primary" style="width:100%;margin-top:12px">
          <i class="fas fa-sync-alt"></i> Generate Insights
        </button>
      </div>

      <!-- Forecast Section -->
      <div class="card" style="grid-column:span 6">
        <h3 style="margin:0">Revenue Forecast</h3>
        <div class="forecast-container">
          <div class="forecast-header">
            <span>Next 3 months projection</span>
            <select id="forecastModel">
              <option value="linear">Linear Trend</option>
              <option value="seasonal">Seasonal Model</option>
              <option value="moving">Moving Average</option>
            </select>
          </div>
          <canvas id="forecastChart" style="height:200px"></canvas>
          <div id="forecastDetails"></div>
        </div>
      </div>

      <!-- Performance Table -->
      <div class="card" style="grid-column:span 12">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <h3 style="margin:0">Branch Performance Table</h3>
          <div class="muted-small">Click header to sort â€” numbers are click-selectable</div>
        </div>
        <table id="perfTable"></table>
      </div>

      <!-- Branch Comparison -->
      <div class="card" style="grid-column:span 12">
        <h3 style="margin:0">Branch Comparison</h3>
        <div style="display:flex;gap:12px;margin-bottom:16px">
          <select id="compareBranch1">
            <option value="">Select Branch 1</option>
          </select>
          <select id="compareBranch2">
            <option value="">Select Branch 2</option>
          </select>
          <button id="compareBtn" class="btn-primary">Compare</button>
        </div>
        <div id="comparisonContainer">
          <canvas id="comparisonChart"></canvas>
        </div>
      </div>
    </section>

    <!-- Add New Data Section -->
    <div class="add-data-section">
      <h3><i class="fas fa-plus-circle"></i> Add New Data</h3>
      <form id="addDataForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="newMonth">Month</label>
            <select id="newMonth" required>
              <option value="">Select Month</option>
              <option value="Jan">January</option>
              <option value="Feb">February</option>
              <option value="Mar">March</option>
              <option value="Apr">April</option>
              <option value="May">May</option>
              <option value="Jun">June</option>
              <option value="Jul">July</option>
              <option value="Aug">August</option>
              <option value="Sep">September</option>
              <option value="Oct">October</option>
              <option value="Nov">November</option>
              <option value="Dec">December</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="newBranch">Branch</label>
            <input type="text" id="newBranch" placeholder="Enter branch name" required>
          </div>
          
          <div class="form-group">
            <label for="newChannel">Channel</label>
            <select id="newChannel" required>
              <option value="">Select Channel</option>
              <option value="Dining Takeaway">Dining Takeaway</option>
              <option value="Self Delivery">Self Delivery</option>
              <option value="Online Web">Online Web</option>
              <option value="NOON">NOON</option>
              <option value="Careem">Careem</option>
              <option value="Smile">Smile</option>
              <option value="Deliveroo">Deliveroo</option>
              <option value="Keeta">Keeta</option>
              <option value="Talabat">Talabat</option>
              <option value="Talabana">Talabana</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="newS24">Sales 2024 (AED)</label>
            <input type="number" id="newS24" placeholder="0" required>
          </div>
          
          <div class="form-group">
            <label for="newS25">Sales 2025 (AED)</label>
            <input type="number" id="newS25" placeholder="0" required>
          </div>
          
          <div class="form-group">
            <label for="newO24">Orders 2024</label>
            <input type="number" id="newO24" placeholder="0" required>
          </div>
          
          <div class="form-group">
            <label for="newO25">Orders 2025</label>
            <input type="number" id="newO25" placeholder="0" required>
          </div>
        </div>
        
        <div class="data-preview" id="dataPreview" style="display: none;">
          <h4>Data Preview</h4>
          <div class="preview-item">
            <span class="preview-label">Branch:</span>
            <span class="preview-value" id="previewBranch">-</span>
          </div>
          <div class="preview-item">
            <span class="preview-label">Month:</span>
            <span class="preview-value" id="previewMonth">-</span>
          </div>
          <div class="preview-item">
            <span class="preview-label">Channel:</span>
            <span class="preview-value" id="previewChannel">-</span>
          </div>
          <div class="preview-item">
            <span class="preview-label">Sales 2024:</span>
            <span class="preview-value" id="previewS24">-</span>
          </div>
          <div class="preview-item">
            <span class="preview-label">Sales 2025:</span>
            <span class="preview-value" id="previewS25">-</span>
          </div>
          <div class="preview-item">
            <span class="preview-label">Orders 2024:</span>
            <span class="preview-value" id="previewO24">-</span>
          </div>
          <div class="preview-item">
            <span class="preview-label">Orders 2025:</span>
            <span class="preview-value" id="previewO25">-</span>
          </div>
        </div>
        
        <div class="form-actions">
          <button type="button" id="previewBtn" class="btn-secondary">Preview</button>
          <button type="submit" id="addDataBtn" class="btn-primary">
            <i class="fas fa-plus"></i> Add Data
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Notification -->
  <div id="notification" class="notification">Data exported successfully!</div>

  <!-- Keyboard Shortcuts Help -->
  <div id="shortcuts" class="shortcuts">
    <div class="shortcut-item">
      <span>Toggle Theme</span>
      <span class="shortcut-key">Ctrl+T</span>
    </div>
    <div class="shortcut-item">
      <span>Reset Dashboard</span>
      <span class="shortcut-key">Ctrl+R</span>
    </div>
    <div class="shortcut-item">
      <span>Export Data</span>
      <span class="shortcut-key">Ctrl+E</span>
    </div>
    <div class="shortcut-item">
      <span>Generate Insights</span>
      <span class="shortcut-key">Ctrl+I</span>
    </div>
    <div class="shortcut-item">
      <span>Add New Data</span>
      <span class="shortcut-key">Ctrl+N</span>
    </div>
    <div class="shortcut-item">
      <span>Help</span>
      <span class="shortcut-key">Ctrl+H</span>
    </div>
  </div>

  <script>
  /* =========================
     REAL MONTHLY DATA FOR EACH BRANCH
     ========================= */
  const MONTHLY_DATA = {
    'Hamdan St': {
      2024: [892751, 838890, 901152, 773528, 942153, 865784, 766048, 755777, 750025, 811774, 818720, 928011],
      2025: [785182.88, 741199.15, 603475.30, 713032.85, 779896.16, 802422.70, 777059.15, 755184.50, 722126.83, 763733.10, 698415.45, 722511.52]
    },
    'Al Khalidiyah': {
      2024: [669628, 610550, 660943, 551042, 678124, 654049, 603196, 634519, 595151, 636537, 610904, 655975],
      2025: [584685.40, 557488.90, 458231.50, 568123.40, 636993.45, 673051.75, 694472.40, 637005.25, 571512.20, 627570.94, 589234.67, 612876.89]
    },
    'Shabiya 11': {
      2024: [587129, 550560, 578283, 466055, 597799, 580383, 543793, 559377, 553745, 628475, 618859, 664369],
      2025: [631030.60, 621153.70, 449433.70, 638249.55, 690026.34, 709110.50, 741667.75, 694108.25, 669003.30, 744778.92, 723456.78, 747889.23]
    },
    'Muroor': {
      2024: [437919, 426209, 456296, 360182, 461656, 457288, 420309, 432152, 420305, 471405, 489209, 504682],
      2025: [527557.59, 498935.70, 347325.20, 526701.40, 537997.55, 572960.75, 564894.00, 516549.30, 493890.77, 536168.33, 512345.67, 535678.91]
    },
    'Electra': {
      2024: [0, 0, 0, 0, 14923, 527014, 519470, 550502, 557708, 660558, 656417, 771373],
      2025: [0, 0, 0, 0, 805574.13, 835561.10, 857462.90, 805213.30, 727586.93, 825524.92, 789345.67, 812678.34]
    },
    'Al Barsha': {
      2024: [595307, 553496, 533280, 492132, 603860, 589616, 563998, 559963, 602657, 659575, 620272, 677889],
      2025: [628391.48, 639427.95, 488007.40, 621490.20, 638426.90, 647001.34, 679338.70, 618760.10, 699238.28, 926324.70, 878456.32, 902789.65]
    },
    'Al Satwa': {
      2024: [0, 0, 0, 0, 246401, 279419, 277393, 305167, 333262, 396730, 383740, 457464],
      2025: [0, 0, 0, 0, 467366.25, 509383.02, 522713.70, 532036.55, 557244.49, 655294.15, 623456.78, 647789.23]
    },
    'Al Rigga': {
      2024: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      2025: [0, 0, 0, 0, 0, 0, 0, 0, 76198.20, 773870.29, 82345.67, 85678.34]
    }
  };

  // Channel Performance Data
  const CHANNEL_DATA = [
    { channel: 'Careem', sales2025: 4447023.88, sales2024: 950012 },
    { channel: 'Deliveroo', sales2025: 310045.40, sales2024: 367162 },
    { channel: 'Dining Takeaway', sales2025: 22762541, sales2024: 18532229 },
    { channel: 'Keeta', sales2025: 771013.10, sales2024: 0 },
    { channel: 'NOON', sales2025: 6615356.05, sales2024: 4478670 },
    { channel: 'Online Web', sales2025: 874256, sales2024: 912564 },
    { channel: 'Self Delivery', sales2025: 3401506, sales2024: 3806008 },
    { channel: 'Smile', sales2025: 2076596, sales2024: 1766060 },
    { channel: 'Talabana', sales2025: 202.59, sales2024: 57578 },
    { channel: 'Talabat', sales2025: 3455930, sales2024: 4135900 }
  ];

  // utilities
  const branches = Object.keys(MONTHLY_DATA);
  
  function getBranchTotal(branch, year) {
    const data = MONTHLY_DATA[branch];
    if (!data || !data[year]) return 0;
    return data[year].reduce((sum, val) => sum + (val || 0), 0);
  }

  const totals25 = branches.map(b => getBranchTotal(b, 2025));
  const totals24 = branches.map(b => getBranchTotal(b, 2024));

  function fmt(n){ return Number(n).toLocaleString(); }
  function growth(a,b){ 
    if (a === 0) return b === 0 ? 0 : 100;
    return ((b - a) / a) * 100;
  }

  /* Deterministic pseudo-random generator from string (for monthly data) */
  function seedFromString(s){
    let h=2166136261 >>> 0;
    for(let i=0;i<s.length;i++){
      h ^= s.charCodeAt(i);
      h += (h<<1) + (h<<4) + (h<<7) + (h<<8) + (h<<24);
    }
    return h >>> 0;
  }
  function seededRandom(seed){
    // simple xorshift
    let x = seed || 123456789;
    return function(){
      x ^= x << 13;
      x ^= x >>> 17;
      x ^= x << 5;
      return ((x >>> 0) % 1000000) / 1000000;
    };
  }

  // generate an inline SVG logo (initials + color)
  function makeLogoDataURL(name, size=64){
    const initials = name.split(' ').map(p=>p[0]).slice(0,2).join('').toUpperCase();
    const colors = ['#4f46e5','#10b981','#ef4444','#f59e0b','#06b6d4','#8b5cf6','#f97316','#0ea5a4'];
    const idx = seedFromString(name) % colors.length;
    const bg = colors[idx];
    const fg = '#fff';
    const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${size}' height='${size}'>
      <rect width='100%' height='100%' rx='12' fill='${bg}'/>
      <text x='50%' y='50%' font-size='28' fill='${fg}' font-family='Inter,Helvetica,Arial' dominant-baseline='middle' text-anchor='middle' font-weight='700'>${initials}</text>
    </svg>`;
    return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
  }

  /* =========================
     UI Elements
     ========================= */
  const branchSelect = document.getElementById('branchSelect');
  const branchLogo = document.getElementById('branchLogo');
  const yearSelect = document.getElementById('yearSelect');

  // populate branch select
  branches.forEach(b=>{
    const o = document.createElement('option');
    o.value = b; o.textContent = b;
    branchSelect.appendChild(o);
  });
  branchSelect.value = branches[0];

  // populate comparison selects
  const compareBranch1 = document.getElementById('compareBranch1');
  const compareBranch2 = document.getElementById('compareBranch2');
  branches.forEach(b=>{
    const o1 = document.createElement('option');
    o1.value = b; o1.textContent = b;
    compareBranch1.appendChild(o1);
    
    const o2 = document.createElement('option');
    o2.value = b; o2.textContent = b;
    compareBranch2.appendChild(o2);
  });

  // set initial logo
  branchLogo.src = makeLogoDataURL(branchSelect.value);

  /* =========================
     KPIs + Table + Charts
     ========================= */
  const elVal24 = document.getElementById('val2024');
  const elVal25 = document.getElementById('val2025');
  const elGrowth = document.getElementById('growthVal');
  const elBest = document.getElementById('bestBranch');
  const kpi24sub = document.getElementById('kpi24sub');
  const kpi25sub = document.getElementById('kpi25sub');
  const growthSub = document.getElementById('growthSub');
  const bestSub = document.getElementById('bestSub');

  function updateKPIs(){
    const br = branchSelect.value;
    const idx = branches.indexOf(br);
    const t24 = totals24[idx] || 0;
    const t25 = totals25[idx] || 0;
    elVal24.textContent = fmt(t24);
    elVal25.textContent = fmt(t25);

    const g = growth(t24, t25);
    elGrowth.textContent = (g>0 ? 'ðŸ”¼ ':'ðŸ”» ') + Math.abs(g).toFixed(1) + '%';
    elGrowth.className = g>=0 ? 'up' : 'down';
    kpi24sub.textContent = 'Sum of 12 months (2024)';
    kpi25sub.textContent = 'Sum of 12 months (2025)';
    growthSub.textContent = `(${ (t25 - t24).toLocaleString() } AED change)`;

    // best branch
    const maxIdx = totals25.indexOf(Math.max(...totals25));
    elBest.textContent = branches[maxIdx];
    bestSub.textContent = `Top by 2025 revenue: ${fmt(totals25[maxIdx])}`;
    // update branch logo
    branchLogo.src = makeLogoDataURL(br);
  }

  // Table
  const perfTable = document.getElementById('perfTable');
  let currentSort = {col:'2025',dir:'desc'}; // default sort
  function buildTable(){
    const headers = ['Branch','2024 (AED)','2025 (AED)','Growth %'];
    let html = `<thead><tr>`;
    headers.forEach(h=>{
      html += `<th data-col="${h}" style="cursor:pointer">${h}</th>`;
    });
    html += `</tr></thead><tbody>`;
    const rows = branches.map(branch => {
      const t24 = getBranchTotal(branch, 2024);
      const t25 = getBranchTotal(branch, 2025);
      const g = growth(t24, t25);
      return {branch,t24,t25,g};
    });

    // sort
    rows.sort((a,b)=>{
      if(currentSort.col==='2025 (AED)') return currentSort.dir==='desc' ? b.t25 - a.t25 : a.t25 - b.t25;
      if(currentSort.col==='2024 (AED)') return currentSort.dir==='desc' ? b.t24 - a.t24 : a.t24 - b.t24;
      if(currentSort.col==='Growth %') return currentSort.dir==='desc' ? b.g - a.g : a.g - b.g;
      return currentSort.dir==='desc' ? b.t25 - a.t25 : a.t25 - b.t25;
    });

    rows.forEach(r=>{
      html += `<tr>
        <td style="display:flex;gap:8px;align-items:center"><img src="${makeLogoDataURL(r.branch,36)}" style="width:36px;height:36px;border-radius:8px" /> ${r.branch}</td>
        <td>${fmt(r.t24)}</td>
        <td>${fmt(r.t25)}</td>
        <td class="${r.g>=0 ? 'up':'down'}">${r.g.toFixed(1)}%</td>
      </tr>`;
    });
    html += `</tbody>`;
    perfTable.innerHTML = html;

    // attach header click events for sorting
    const ths = perfTable.querySelectorAll('th');
    ths.forEach(th=>{
      th.onclick = ()=>{
        const col = th.getAttribute('data-col');
        if(currentSort.col === col) currentSort.dir = currentSort.dir === 'desc' ? 'asc' : 'desc';
        else { currentSort.col = col; currentSort.dir='desc'; }
        buildTable();
      };
    });
  }

  // Channel Performance
  function renderChannelPerformance() {
    const channelGrid = document.getElementById('channelGrid');
    channelGrid.innerHTML = '';
    
    const total2024 = CHANNEL_DATA.reduce((sum, channel) => sum + channel.sales2024, 0);
    const total2025 = CHANNEL_DATA.reduce((sum, channel) => sum + channel.sales2025, 0);
    
    CHANNEL_DATA.forEach(channel => {
      const growthRate = growth(channel.sales2024, channel.sales2025);
      const marketShare2024 = total2024 > 0 ? (channel.sales2024 / total2024 * 100) : 0;
      const marketShare2025 = total2025 > 0 ? (channel.sales2025 / total2025 * 100) : 0;
      
      const channelCard = document.createElement('div');
      channelCard.className = 'channel-card';
      
      // Determine card type based on growth
      if (growthRate > 20) {
        channelCard.classList.add('success');
      } else if (growthRate < 0) {
        channelCard.classList.add('danger');
      } else if (growthRate === 100) {
        channelCard.classList.add('info');
      } else {
        channelCard.classList.add('warning');
      }
      
      channelCard.innerHTML = `
        <div class="channel-header">
          <div class="channel-name">${channel.channel}</div>
          <div class="channel-growth ${growthRate >= 0 ? 'positive' : 'negative'}">
            ${growthRate === 100 ? 'New' : growthRate.toFixed(1) + '%'}
          </div>
        </div>
        <div class="channel-metrics">
          <div class="channel-metric">
            <div class="channel-metric-value">${fmt(channel.sales2025)}</div>
            <div class="channel-metric-label">2025 Sales</div>
          </div>
          <div class="channel-metric">
            <div class="channel-metric-value">${fmt(channel.sales2024)}</div>
            <div class="channel-metric-label">2024 Sales</div>
          </div>
          <div class="channel-metric">
            <div class="channel-metric-value">${marketShare2025.toFixed(1)}%</div>
            <div class="channel-metric-label">Market Share</div>
          </div>
        </div>
        <div class="channel-progress">
          <div class="channel-progress-bar" style="width: ${marketShare2025}%"></div>
        </div>
      `;
      
      channelGrid.appendChild(channelCard);
    });
  }

  /* =========================
     Charts (Chart.js)
     ========================= */
  let branchChart, rankChart, trendChart, forecastChart, comparisonChart;
  let currentChartType = 'branch';
  
  function renderCharts(){
    // destroy if exists
    if(branchChart) branchChart.destroy();
    if(rankChart) rankChart.destroy();
    if(trendChart) trendChart.destroy();
    if(forecastChart) forecastChart.destroy();
    if(comparisonChart) comparisonChart.destroy();

    // Branch comparison chart
    const ctx1 = document.getElementById('branchChart');
    
    if (currentChartType === 'branch') {
      branchChart = new Chart(ctx1, {
        type: 'bar',
        data: {
          labels: branches,
          datasets: [
            { label:'2024', data: totals24, borderRadius:6, barThickness:18, backgroundColor: branches.map((b,i)=>makeChartColor(b,0.32)) },
            { label:'2025', data: totals25, borderRadius:6, barThickness:18, backgroundColor: branches.map((b,i)=>makeChartColor(b,0.86)) }
          ]
        },
        options: {
          responsive:true,
          interaction:{mode:'index'},
          plugins:{legend:{position:'top'}},
          scales:{y:{ticks:{callback: v => v >= 1000 ? (v/1000)+'k' : v}}}
        }
      });
    } else if (currentChartType === 'growth') {
      branchChart = new Chart(ctx1, {
        type: 'bar',
        data: {
          labels: branches,
          datasets: [{
            label: 'Growth %',
            data: branches.map(branch => growth(getBranchTotal(branch, 2024), getBranchTotal(branch, 2025))),
            backgroundColor: branches.map(branch => growth(getBranchTotal(branch, 2024), getBranchTotal(branch, 2025)) >= 0 ? makeChartColor('success', 0.8) : makeChartColor('danger', 0.8))
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              ticks: {
                callback: v => v + '%'
              }
            }
          }
        }
      });
    } else if (currentChartType === 'market') {
      const totalMarket25 = totals25.reduce((a, b) => a + b, 0);
      branchChart = new Chart(ctx1, {
        type: 'doughnut',
        data: {
          labels: branches,
          datasets: [{
            data: totals25,
            backgroundColor: branches.map(b => makeChartColor(b, 0.8)),
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'right'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.raw;
                  const percentage = ((value / totalMarket25) * 100).toFixed(1);
                  return `${context.label}: ${fmt(value)} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }

    // Ranking chart: horizontal bars sorted by 2025
    const sorted = branches.map((branch, i) => ({branch, total: totals25[i]})).sort((a,b)=>b.total-a.total);
    rankChart = new Chart(document.getElementById('rankChart'), {
      type: 'bar',
      data: {
        labels: sorted.map(r=>r.branch),
        datasets: [{ label:'2025 Revenue', data: sorted.map(r=>r.total), barThickness:14, backgroundColor: sorted.map((r,i)=>makeChartColor(r.branch,0.7)) }]
      },
      options: {
        indexAxis:'y', responsive:true, plugins:{legend:{display:false}},
        scales:{x:{ticks:{callback: v => v >= 1000 ? (v/1000)+'k' : v}}}
      }
    });

    // Trend chart: show selected branch monthly data lines for 2024 & 2025
    const br = branchSelect.value;
    const monthly = MONTHLY_DATA[br];
    trendChart = new Chart(document.getElementById('trendChart'), {
      type:'line',
      data:{
        labels:['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
        datasets:[
          { label:'2024', data: monthly[2024], tension:0.32, pointRadius:4, borderWidth:2, fill:true, backgroundColor: makeGradient('2024'), borderColor: makeChartColor(br,0.86) },
          { label:'2025', data: monthly[2025], tension:0.32, pointRadius:4, borderWidth:2, fill:false, borderDash:[4,4], borderColor: makeChartColor(br,1) }
        ]
      },
      options:{responsive:true,plugins:{legend:{position:'top'}},scales:{y:{ticks:{callback:v => v>=1000 ? (v/1000)+'k' : v}}}}
    });

    // Forecast chart
    renderForecast();
    
    // Comparison chart (will be rendered when compare button is clicked)
  }

  // Forecast chart
  function renderForecast() {
    const model = document.getElementById('forecastModel').value;
    const br = branchSelect.value;
    const monthly = MONTHLY_DATA[br];
    
    // Simple forecast based on selected model
    let forecast = [];
    if (model === 'linear') {
      // Simple linear projection based on trend
      const trend = (monthly[2025][11] - monthly[2025][0]) / 11;
      forecast = [
        monthly[2025][11] + trend,
        monthly[2025][11] + trend * 2,
        monthly[2025][11] + trend * 3
      ];
    } else if (model === 'seasonal') {
      // Seasonal projection (add seasonal variation)
      const avgMonthly = monthly[2025].reduce((a, b) => a + b, 0) / 12;
      forecast = [
        avgMonthly * 1.1, // Slight increase for next Jan
        avgMonthly * 1.15, // Slight increase for next Feb
        avgMonthly * 1.2   // Slight increase for next Mar
      ];
    } else if (model === 'moving') {
      // Moving average forecast
      const avgLast3 = (monthly[2025][9] + monthly[2025][10] + monthly[2025][11]) / 3;
      forecast = [
        avgLast3,
        avgLast3,
        avgLast3
      ];
    }
    
    const forecastCtx = document.getElementById('forecastChart');
    forecastChart = new Chart(forecastCtx, {
      type: 'line',
      data: {
        labels: ['Jan 2026', 'Feb 2026', 'Mar 2026'],
        datasets: [
          {
            label: 'Historical',
            data: monthly[2025].slice(-3),
            borderColor: makeChartColor(br, 0.86),
            backgroundColor: makeChartColor(br, 0.2),
            fill: true
          },
          {
            label: 'Forecast',
            data: forecast,
            borderColor: makeChartColor('warning', 1),
            borderDash: [5, 5],
            pointBackgroundColor: makeChartColor('warning', 1),
            pointRadius: 6
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'top'
          }
        },
        scales: {
          y: {
            ticks: {
              callback: v => v >= 1000 ? (v/1000)+'k' : v
            }
          }
        }
      }
    });
    
    // Update forecast details
    const forecastDetails = document.getElementById('forecastDetails');
    forecastDetails.innerHTML = `
      <div class="forecast-item">
        <span>Projected Q1 2026 Revenue</span>
        <span class="up">${fmt(forecast.reduce((a, b) => a + b, 0))} AED</span>
      </div>
      <div class="forecast-item">
        <span>Monthly Average</span>
        <span>${fmt(forecast.reduce((a, b) => a + b, 0) / 3)} AED</span>
      </div>
    `;
  }

  // Branch comparison
  function renderComparison() {
    const br1 = document.getElementById('compareBranch1').value;
    const br2 = document.getElementById('compareBranch2').value;
    
    if (!br1 || !br2) return;
    
    const monthly1 = MONTHLY_DATA[br1];
    const monthly2 = MONTHLY_DATA[br2];
    
    const comparisonCtx = document.getElementById('comparisonChart');
    comparisonChart = new Chart(comparisonCtx, {
      type: 'line',
      data: {
        labels: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
        datasets: [
          {
            label: br1 + ' - 2025',
            data: monthly1[2025],
            borderColor: makeChartColor(br1, 0.86),
            backgroundColor: makeChartColor(br1, 0.2),
            fill: true
          },
          {
            label: br2 + ' - 2025',
            data: monthly2[2025],
            borderColor: makeChartColor(br2, 0.86),
            backgroundColor: makeChartColor(br2, 0.2),
            fill: true
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Monthly Comparison: ' + br1 + ' vs ' + br2
          },
          legend: {
            position: 'top'
          }
        },
        scales: {
          y: {
            ticks: {
              callback: v => v >= 1000 ? (v/1000)+'k' : v
            }
          }
        }
      }
    });
  }

  // helper: make chart color from branch name
  function makeChartColor(name, alpha=1){
    const colors = ['63,81,181','16,185,129','239,68,68','245,158,11','6,182,212','139,92,246','249,115,22','14,165,164'];
    const idx = seedFromString(name) % colors.length;
    return `rgba(${colors[idx]},${alpha})`;
  }

  function makeGradient(year){
    // gradient for trend fill
    const canvas = document.getElementById('trendChart');
    const ctx = canvas.getContext('2d');
    const g = ctx.createLinearGradient(0,0,0,200);
    if(year==='2024'){ g.addColorStop(0, 'rgba(79,70,229,0.12)'); g.addColorStop(1, 'rgba(79,70,229,0.01)'); }
    else { g.addColorStop(0, 'rgba(16,185,129,0.06)'); g.addColorStop(1, 'rgba(16,185,129,0.01)'); }
    return g;
  }

  /* =========================
     Export: CSV & PDF & Excel & JSON
     ========================= */
  function exportCSV(){
    // CSV includes monthly breakdown for all branches for 2024 & 2025
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    let csv = 'Branch,Year,' + months.join(',') + ',Total\n';
    branches.forEach(branch => {
      const data = MONTHLY_DATA[branch];
      csv += `${branch},2024,` + data[2024].join(',') + ',' + getBranchTotal(branch, 2024) + '\n';
      csv += `${branch},2025,` + data[2025].join(',') + ',' + getBranchTotal(branch, 2025) + '\n';
    });
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `crispy_chicken_export_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    showNotification('CSV exported successfully!', 'success');
  }

  function exportExcel() {
    // Create a new workbook
    const wb = XLSX.utils.book_new();
    
    // Create a worksheet for summary data
    const summaryData = branches.map(branch => ({
      Branch: branch,
      '2024 Total': getBranchTotal(branch, 2024),
      '2025 Total': getBranchTotal(branch, 2025),
      'Growth %': growth(getBranchTotal(branch, 2024), getBranchTotal(branch, 2025)).toFixed(2) + '%'
    }));
    const wsSummary = XLSX.utils.json_to_sheet(summaryData);
    
    // Create a worksheet for monthly data
    const monthlyData = [];
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    
    // Header row
    const header = ['Branch'];
    months.forEach(month => {
      header.push(month + ' 2024', month + ' 2025');
    });
    header.push('2024 Total', '2025 Total');
    monthlyData.push(header);
    
    // Data rows
    branches.forEach(branch => {
      const row = [branch];
      const data = MONTHLY_DATA[branch];
      
      // Add monthly data for 2024 and 2025
      months.forEach(month => {
        row.push(data[2024][months.indexOf(month)]);
        row.push(data[2025][months.indexOf(month)]);
      });
      
      // Add totals
      row.push(getBranchTotal(branch, 2024), getBranchTotal(branch, 2025));
      monthlyData.push(row);
    });
    
    const wsMonthly = XLSX.utils.aoa_to_sheet(monthlyData);
    
    // Create a worksheet for channel data
    const channelData = CHANNEL_DATA.map(c => ({
      Channel: c.channel,
      '2024 Sales': c.sales2024,
      '2025 Sales': c.sales2025,
      'Growth %': growth(c.sales2024, c.sales2025).toFixed(2) + '%'
    }));
    const wsChannel = XLSX.utils.json_to_sheet(channelData);
    
    // Add worksheets to workbook
    XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary');
    XLSX.utils.book_append_sheet(wb, wsMonthly, 'Monthly Data');
    XLSX.utils.book_append_sheet(wb, wsChannel, 'Channel Data');
    
    // Generate and download file
    XLSX.writeFile(wb, `crispy_chicken_report_${new Date().toISOString().slice(0,10)}.xlsx`);
    showNotification('Excel exported successfully!', 'success');
  }

  function exportJSON() {
    const reportData = {
      metadata: {
        generatedAt: new Date().toISOString(),
        title: 'Crispy Chicken Performance Report',
        period: '2024 vs 2025'
      },
      summary: branches.map(branch => ({
        branch: branch,
        total2024: getBranchTotal(branch, 2024),
        total2025: getBranchTotal(branch, 2025),
        growth: growth(getBranchTotal(branch, 2024), getBranchTotal(branch, 2025))
      })),
      channels: CHANNEL_DATA.map(c => ({
        channel: c.channel,
        sales2024: c.sales2024,
        sales2025: c.sales2025,
        growth: growth(c.sales2024, c.sales2025)
      })),
      monthlyData: {}
    };
    
    // Add monthly data for each branch
    branches.forEach(branch => {
      reportData.monthlyData[branch] = MONTHLY_DATA[branch];
    });
    
    // Create and download file
    const jsonStr = JSON.stringify(reportData, null, 2);
    const blob = new Blob([jsonStr], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `crispy_chicken_report_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    showNotification('JSON exported successfully!', 'success');
  }

  async function exportPDF(){
    // capture dashboard element and produce PDF with multiple pages
    const dashboard = document.getElementById('dashboard');
    // temporarily expand charts for better capture
    const origWidth = dashboard.style.width;
    dashboard.style.width = '1200px';
    
    // Show loading indicator
    const loading = document.createElement('div');
    loading.style.position = 'fixed';
    loading.style.top = '50%';
    loading.style.left = '50%';
    loading.style.transform = 'translate(-50%, -50%)';
    loading.style.padding = '20px';
    loading.style.background = 'rgba(255,255,255,0.9)';
    loading.style.borderRadius = '8px';
    loading.style.zIndex = '1000';
    loading.innerHTML = '<div class="loading"></div><div style="margin-top:10px;text-align:center">Generating PDF...</div>';
    document.body.appendChild(loading);
    
    try {
      // capture
      const canvas = await html2canvas(dashboard, {scale:1.6, backgroundColor: getComputedStyle(document.body).backgroundColor});
      dashboard.style.width = origWidth;
      
      // Remove loading indicator
      document.body.removeChild(loading);
      
      const imgData = canvas.toDataURL('image/jpeg',0.9);
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('landscape', 'pt', 'a4');
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = pdf.internal.pageSize.getHeight();
      
      // Add title page
      pdf.setFontSize(20);
      pdf.text('Crispy Chicken Performance Report', 20, 40);
      pdf.setFontSize(12);
      pdf.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 60);
      pdf.text(`Period: 2024 vs 2025`, 20, 80);
      
      // Add summary data
      pdf.setFontSize(14);
      pdf.text('Summary', 20, 110);
      pdf.setFontSize(10);
      let y = 130;
      branches.forEach(branch => {
        const t24 = getBranchTotal(branch, 2024);
        const t25 = getBranchTotal(branch, 2025);
        const line = `${branch} â€” 2024: ${fmt(t24)}, 2025: ${fmt(t25)}, Growth: ${growth(t24, t25).toFixed(1)}%`;
        if(y > pdfHeight - 40){ pdf.addPage(); y = 40; }
        pdf.text(line, 20, y);
        y += 16;
      });
      
      // Add channel data
      pdf.addPage();
      pdf.setFontSize(14);
      pdf.text('Channel Performance', 20, 40);
      pdf.setFontSize(10);
      y = 60;
      CHANNEL_DATA.forEach(c => {
        const line = `${c.channel} â€” 2024: ${fmt(c.sales2024)}, 2025: ${fmt(c.sales2025)}, Growth: ${growth(c.sales2024, c.sales2025).toFixed(1)}%`;
        if(y > pdfHeight - 40){ pdf.addPage(); y = 40; }
        pdf.text(line, 20, y);
        y += 16;
      });
      
      // Add second page with dashboard image
      pdf.addPage();
      pdf.addImage(imgData, 'JPEG', 12, 12, pdfWidth-24, (canvas.height * (pdfWidth-24) / canvas.width));
      
      // Add third page with detailed analysis
      pdf.addPage();
      pdf.setFontSize(14);
      pdf.text('Detailed Analysis', 20, 40);
      pdf.setFontSize(10);
      y = 60;
      
      // Add insights
      const insights = generateInsights();
      insights.forEach(insight => {
        pdf.setFontSize(12);
        pdf.text(insight.title, 20, y);
        y += 10;
        pdf.setFontSize(10);
        const lines = pdf.splitTextToSize(insight.description, pdfWidth - 40);
        lines.forEach(line => {
          pdf.text(line, 20, y);
          y += 6;
        });
        y += 10;
      });
      
      // Save PDF
      pdf.save(`crispy_chicken_dashboard_${new Date().toISOString().slice(0,10)}.pdf`);
      showNotification('PDF exported successfully!', 'success');
    } catch (error) {
      console.error('Error generating PDF:', error);
      document.body.removeChild(loading);
      showNotification('Error generating PDF. Please try again.', 'error');
    }
  }

  function saveAsImage() {
    const dashboard = document.getElementById('dashboard');
    
    // Show loading indicator
    const loading = document.createElement('div');
    loading.style.position = 'fixed';
    loading.style.top = '50%';
    loading.style.left = '50%';
    loading.style.transform = 'translate(-50%, -50%)';
    loading.style.padding = '20px';
    loading.style.background = 'rgba(255,255,255,0.9)';
    loading.style.borderRadius = '8px';
    loading.style.zIndex = '1000';
    loading.innerHTML = '<div class="loading"></div><div style="margin-top:10px;text-align:center">Saving image...</div>';
    document.body.appendChild(loading);
    
    html2canvas(dashboard, {scale:2, backgroundColor: getComputedStyle(document.body).backgroundColor})
      .then(canvas => {
        // Remove loading indicator
        document.body.removeChild(loading);
        
        // Create download link
        const link = document.createElement('a');
        link.download = `crispy_chicken_dashboard_${new Date().toISOString().slice(0,10)}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
        
        showNotification('Image saved successfully!', 'success');
      })
      .catch(error => {
        console.error('Error saving image:', error);
        document.body.removeChild(loading);
        showNotification('Error saving image. Please try again.', 'error');
      });
  }

  /* =========================
     Generate Insights
     ========================= */
  function generateInsights() {
    const insights = [];
    
    // Overall performance analysis
    const totalSales2024 = totals24.reduce((a, b) => a + b, 0);
    const totalSales2025 = totals25.reduce((a, b) => a + b, 0);
    const overallGrowth = growth(totalSales2024, totalSales2025);
    
    if (overallGrowth > 0) {
      insights.push({
        title: 'Positive Overall Growth',
        description: `Total sales increased by ${overallGrowth.toFixed(1)}% from 2024 to 2025, indicating strong business performance across all branches.`
      });
    } else {
      insights.push({
        title: 'Sales Decline',
        description: `Total sales decreased by ${Math.abs(overallGrowth).toFixed(1)}% from 2024 to 2025. Review strategies to reverse this trend.`
      });
    }
    
    // Top performing branch
    const topBranchIndex = totals25.indexOf(Math.max(...totals25));
    const topBranch = branches[topBranchIndex];
    const topBranchGrowth = growth(totals24[topBranchIndex], totals25[topBranchIndex]);
    
    insights.push({
      title: 'Top Performing Branch',
      description: `${topBranch} leads with ${fmt(totals25[topBranchIndex])} AED in 2025, showing ${topBranchGrowth > 0 ? 'positive' : 'negative'} growth of ${Math.abs(topBranchGrowth).toFixed(1)}%.`
    });
    
    // Fastest growing branch
    const growthRates = branches.map(branch => growth(getBranchTotal(branch, 2024), getBranchTotal(branch, 2025)));
    const maxGrowthIndex = growthRates.indexOf(Math.max(...growthRates));
    const maxGrowthBranch = branches[maxGrowthIndex];
    const maxGrowthRate = growthRates[maxGrowthIndex];
    
    insights.push({
      title: 'Fastest Growing Branch',
      description: `${maxGrowthBranch} showed the highest growth rate of ${maxGrowthRate.toFixed(1)}%, indicating successful strategies or market expansion.`
    });
    
    // Underperforming branch
    const minGrowthIndex = growthRates.indexOf(Math.min(...growthRates));
    const minGrowthBranch = branches[minGrowthIndex];
    const minGrowthRate = growthRates[minGrowthIndex];
    
    if (minGrowthRate < 0) {
      insights.push({
        title: 'Branch Requiring Attention',
        description: `${minGrowthBranch} experienced a decline of ${Math.abs(minGrowthRate).toFixed(1)}%. Immediate action is needed to address this underperformance.`
      });
    }
    
    // Channel analysis
    const totalChannelSales2024 = CHANNEL_DATA.reduce((sum, c) => sum + c.sales2024, 0);
    const totalChannelSales2025 = CHANNEL_DATA.reduce((sum, c) => sum + c.sales2025, 0);
    const channelGrowth = growth(totalChannelSales2024, totalChannelSales2025);
    
    insights.push({
      title: 'Channel Performance',
      description: `Total channel sales grew by ${channelGrowth.toFixed(1)}% from 2024 to 2025. Top performing channels include Dining Takeaway, NOON, and Careem.`
    });
    
    // New entrant analysis
    const newChannels = CHANNEL_DATA.filter(c => c.sales2024 === 0 && c.sales2025 > 0);
    if (newChannels.length > 0) {
      insights.push({
        title: 'New Market Entrants',
        description: `${newChannels.map(c => c.channel).join(', ')} entered the market in 2025, capturing ${fmt(newChannels.reduce((sum, c) => sum + c.sales2025, 0))} in sales.`
      });
    }
    
    // Declining channels
    const decliningChannels = CHANNEL_DATA.filter(c => growth(c.sales2024, c.sales2025) < 0);
    if (decliningChannels.length > 0) {
      insights.push({
        title: 'Declining Channels',
        description: `${decliningChannels.map(c => c.channel).join(', ')} showed declining sales. Consider reviewing strategies for these channels.`
      });
    }
    
    return insights;
  }

  function displayInsights() {
    const insights = generateInsights();
    const insightsContainer = document.getElementById('insightsContainer');
    
    insightsContainer.innerHTML = insights.map(insight => `
      <div class="insight-card">
        <div class="insight-title">
          <i class="fas fa-lightbulb"></i> ${insight.title}
          <span class="insight-tag">Insight</span>
        </div>
        <div class="insight-content">${insight.description}</div>
      </div>
    `).join('');
  }

  /* =========================
     Theme toggle, reset, login
     ========================= */
  const themeToggle = document.getElementById('themeToggle');
  themeToggle.onclick = ()=>{
    const body = document.body;
    const current = body.getAttribute('data-theme');
    if(current === 'light'){ body.setAttribute('data-theme','dark'); themeToggle.textContent='â˜€ï¸'; }
    else { body.setAttribute('data-theme','light'); themeToggle.textContent='ðŸŒ™'; }
    // re-render charts to read new colors/background
    renderCharts();
  };

  document.getElementById('resetBtn').onclick = ()=>{
    branchSelect.value = branches[0];
    yearSelect.value = 'all';
    currentSort = {col:'2025 (AED)',dir:'desc'};
    updateKPIs(); buildTable(); renderCharts(); renderChannelPerformance();
    showNotification('Dashboard reset to default view', 'success');
  };

  // export buttons
  document.getElementById('exportBtn').onclick = function() {
    document.getElementById('exportDropdown').classList.toggle('show');
  };

  document.getElementById('exportCsv').onclick = function() {
    exportCSV();
    document.getElementById('exportDropdown').classList.remove('show');
  };

  document.getElementById('exportPdf').onclick = function() {
    exportPDF();
    document.getElementById('exportDropdown').classList.remove('show');
  };

  document.getElementById('exportExcel').onclick = function() {
    exportExcel();
    document.getElementById('exportDropdown').classList.remove('show');
  };

  document.getElementById('exportJson').onclick = function() {
    exportJSON();
    document.getElementById('exportDropdown').classList.remove('show');
  };

  document.getElementById('saveImage').onclick = function() {
    saveAsImage();
    document.getElementById('exportDropdown').classList.remove('show');
  };

  // Close dropdown when clicking outside
  window.onclick = function(event) {
    if (!event.target.matches('#exportBtn') && !event.target.closest('#exportDropdown')) {
      document.getElementById('exportDropdown').classList.remove('show');
    }
  }

  // login demo: hide modal and show dashboard
  document.getElementById('loginBtn').onclick = ()=>{
    document.getElementById('loginModal').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    // Initialize dashboard after login
    updateKPIs();
    buildTable();
    renderCharts();
    renderChannelPerformance();
    displayInsights();
    updateTime();
    
    // Start live updates
    setInterval(updateTime, 1000);
    setInterval(simulateActivity, 8000);
    setInterval(updateDashboardData, 30000);
  };

  // when branch selection changes
  branchSelect.onchange = ()=>{
    updateKPIs();
    buildTable();
    renderCharts();
  };
  
  // when year selection changes
  yearSelect.onchange = ()=>{
    // allow toggling datasets: for now, filter charts to only show selected year or both
    const val = yearSelect.value;
    if(val === '2024'){
      // hide 2025 dataset in branchChart and trendChart
      if (branchChart) {
        branchChart.data.datasets[0].hidden = false; // 2024
        branchChart.data.datasets[1].hidden = true;  // 2025
        branchChart.update();
      }
      if (trendChart) {
        trendChart.data.datasets[0].hidden = false;
        trendChart.data.datasets[1].hidden = true;
        trendChart.update();
      }
    } else if(val === '2025'){
      if (branchChart) {
        branchChart.data.datasets[0].hidden = true;
        branchChart.data.datasets[1].hidden = false;
        branchChart.update();
      }
      if (trendChart) {
        trendChart.data.datasets[0].hidden = true;
        trendChart.data.datasets[1].hidden = false;
        trendChart.update();
      }
    } else {
      if (branchChart) {
        branchChart.data.datasets[0].hidden = false;
        branchChart.data.datasets[1].hidden = false;
        branchChart.update();
      }
      if (trendChart) {
        trendChart.data.datasets[0].hidden = false;
        trendChart.data.datasets[1].hidden = false;
        trendChart.update();
      }
    }
  };
  
  // Tab switching for branch chart
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', function() {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      currentChartType = this.getAttribute('data-chart');
      renderCharts();
    });
  });
  
  // Forecast model change
  document.getElementById('forecastModel').addEventListener('change', function() {
    renderForecast();
  });
  
  // Compare branches
  document.getElementById('compareBtn').addEventListener('click', function() {
    renderComparison();
  });

  // Generate insights button
  document.getElementById('generateInsights').addEventListener('click', function() {
    // Show loading state
    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    this.disabled = true;
    
    // Simulate processing time
    setTimeout(() => {
      displayInsights();
      this.innerHTML = '<i class="fas fa-sync-alt"></i> Generate Insights';
      this.disabled = false;
      showNotification('Insights generated successfully!', 'success');
    }, 1500);
  });

  // Show notification
  function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = 'notification show ' + type;
    
    setTimeout(() => {
      notification.classList.remove('show');
    }, 3000);
  }

  /* =========================
     Add New Data Functionality
     ========================= */
  // Preview button
  document.getElementById('previewBtn').addEventListener('click', function() {
    const month = document.getElementById('newMonth').value;
    const branch = document.getElementById('newBranch').value;
    const channel = document.getElementById('newChannel').value;
    const s24 = document.getElementById('newS24').value;
    const s25 = document.getElementById('newS25').value;
    const o24 = document.getElementById('newO24').value;
    const o25 = document.getElementById('newO25').value;
    
    // Check if all fields are filled
    if (!month || !branch || !channel || !s24 || !s25 || !o24 || !o25) {
      showNotification('Please fill all fields before previewing', 'warning');
      return;
    }
    
    // Update preview
    document.getElementById('previewBranch').textContent = branch;
    document.getElementById('previewMonth').textContent = month;
    document.getElementById('previewChannel').textContent = channel;
    document.getElementById('previewS24').textContent = fmt(s24) + ' AED';
    document.getElementById('previewS25').textContent = fmt(s25) + ' AED';
    document.getElementById('previewO24').textContent = fmt(o24);
    document.getElementById('previewO25').textContent = fmt(o25);
    
    // Show preview
    document.getElementById('dataPreview').style.display = 'block';
  });

  // Add data form submission
  document.getElementById('addDataForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Get form values
    const month = document.getElementById('newMonth').value;
    const branch = document.getElementById('newBranch').value;
    const channel = document.getElementById('newChannel').value;
    const s24 = parseFloat(document.getElementById('newS24').value);
    const s25 = parseFloat(document.getElementById('newS25').value);
    const o24 = parseInt(document.getElementById('newO24').value);
    const o25 = parseInt(document.getElementById('newO25').value);
    
    // Validate inputs
    if (!month || !branch || !channel || isNaN(s24) || isNaN(s25) || isNaN(o24) || isNaN(o25)) {
      showNotification('Please fill all fields with valid values', 'warning');
      return;
    }
    
    // Add new data to MONTHLY_DATA
    if (!MONTHLY_DATA[branch]) {
      MONTHLY_DATA[branch] = { 2024: Array(12).fill(0), 2025: Array(12).fill(0) };
    }
    
    const monthIndex = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'].indexOf(month);
    MONTHLY_DATA[branch][2024][monthIndex] = s24;
    MONTHLY_DATA[branch][2025][monthIndex] = s25;
    
    // Update branches array if new branch
    if (!branches.includes(branch)) {
      branches.push(branch);
      
      // Update branch select
      const option = document.createElement('option');
      option.value = branch;
      option.textContent = branch;
      branchSelect.appendChild(option);
      
      // Update comparison selects
      const option1 = document.createElement('option');
      option1.value = branch;
      option1.textContent = branch;
      compareBranch1.appendChild(option1);
      
      const option2 = document.createElement('option');
      option2.value = branch;
      option2.textContent = branch;
      compareBranch2.appendChild(option2);
    }
    
    // Update totals arrays
    const idx = branches.indexOf(branch);
    if (idx === -1) {
      totals24.push(MONTHLY_DATA[branch][2024].reduce((a, b) => a + b, 0));
      totals25.push(MONTHLY_DATA[branch][2025].reduce((a, b) => a + b, 0));
    } else {
      totals24[idx] = MONTHLY_DATA[branch][2024].reduce((a, b) => a + b, 0);
      totals25[idx] = MONTHLY_DATA[branch][2025].reduce((a, b) => a + b, 0);
    }
    
    // Update dashboard
    updateKPIs();
    buildTable();
    renderCharts();
    renderChannelPerformance();
    displayInsights();
    
    // Reset form
    document.getElementById('addDataForm').reset();
    document.getElementById('dataPreview').style.display = 'none';
    
    // Show success notification
    showNotification(`Data added successfully for ${branch}!`, 'success');
  });

  /* =========================
     Live Updates
     ========================= */
  function updateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString();
    document.getElementById('systemTime').textContent = timeString;
    document.getElementById('lastUpdated').textContent = `Last updated: ${timeString}`;
  }

  function simulateActivity() {
    const activities = [
      { type: 'sales', title: 'New order received', message: 'Careem - Al Satwa branch' },
      { type: 'branch', title: 'Branch milestone', message: 'Electria reached $7.5M in sales' },
      { type: 'channel', title: 'Channel growth', message: 'NOON sales increased by 5%' },
      { type: 'sales', title: 'Large order', message: 'Dining Takeaway - $1,200 order' },
      { type: 'branch', title: 'Branch performance', message: 'Al Satwa showing strong growth' }
    ];
    
    const randomActivity = activities[Math.floor(Math.random() * activities.length)];
    addActivityToFeed(randomActivity);
  }

  function addActivityToFeed(activity) {
    const activityFeed = document.getElementById('activityFeedContent');
    if (!activityFeed) return;
    
    const activityItem = document.createElement('div');
    activityItem.className = 'activity-item';
    
    const iconClass = activity.type === 'sales' ? 'sales' : 
                      activity.type === 'branch' ? 'branch' : 'channel';
    const icon = activity.type === 'sales' ? 'ðŸ’°' : 
                 activity.type === 'branch' ? 'ðŸ¢' : 'ðŸ“±';
    
    const now = new Date();
    const timeString = now.toLocaleTimeString();
    
    activityItem.innerHTML = `
      <div class="activity-icon ${iconClass}">${icon}</div>
      <div class="activity-content">
        <div class="activity-title">${activity.title}</div>
        <div>${activity.message}</div>
        <div class="activity-time">${timeString}</div>
      </div>
    `;
    
    // Add to top of feed
    activityFeed.insertBefore(activityItem, activityFeed.firstChild);
    
    // Remove oldest items if more than 10
    const items = activityFeed.querySelectorAll('.activity-item');
    if (items.length > 10) {
      activityFeed.removeChild(items[items.length - 1]);
    }
  }

  function updateDashboardData() {
    // Show progress bar
    const progressContainer = document.querySelector('.progress-container');
    const progressBar = document.querySelector('.progress-bar');
    if (progressContainer) {
      progressContainer.style.display = 'block';
      progressBar.style.width = '0%';
      
      // Simulate loading progress
      let progress = 0;
      const progressInterval = setInterval(() => {
        progress += 10;
        progressBar.style.width = progress + '%';
        
        if (progress >= 100) {
          clearInterval(progressInterval);
          setTimeout(() => {
            progressContainer.style.display = 'none';
            
            // Update KPI values with animation
            animateKPIUpdates();
            
            // Update last updated time
            updateTime();
            
            // Show notification
            showNotification('Dashboard data has been refreshed', 'success');
          }, 500);
        }
      }, 100);
    }
  }

  function animateKPIUpdates() {
    // Add animation class to KPI cards
    const kpiCards = document.querySelectorAll('.kpi-card');
    kpiCards.forEach(card => {
      card.classList.add('updated');
      const valueElement = card.querySelector('.kpi-value');
      if (valueElement) {
        valueElement.classList.add('updating');
        setTimeout(() => {
          valueElement.classList.remove('updating');
        }, 1000);
      }
      setTimeout(() => {
        card.classList.remove('updated');
      }, 2000);
    });
  }

  /* =========================
     Keyboard Shortcuts
     ========================= */
  document.addEventListener('keydown', function(e) {
    // Ctrl+T: Toggle theme
    if (e.ctrlKey && e.key === 't') {
      e.preventDefault();
      themeToggle.click();
    }
    
    // Ctrl+R: Reset dashboard
    if (e.ctrlKey && e.key === 'r') {
      e.preventDefault();
      document.getElementById('resetBtn').click();
    }
    
    // Ctrl+E: Export data
    if (e.ctrlKey && e.key === 'e') {
      e.preventDefault();
      document.getElementById('exportBtn').click();
    }
    
    // Ctrl+I: Generate insights
    if (e.ctrlKey && e.key === 'i') {
      e.preventDefault();
      document.getElementById('generateInsights').click();
    }
    
    // Ctrl+N: Add new data
    if (e.ctrlKey && e.key === 'n') {
      e.preventDefault();
      document.getElementById('newBranch').focus();
    }
    
    // Ctrl+H: Show help
    if (e.ctrlKey && e.key === 'h') {
      e.preventDefault();
      document.getElementById('shortcuts').classList.toggle('show');
    }
  });

  // Help button
  document.getElementById('helpBtn').addEventListener('click', function() {
    document.getElementById('shortcuts').classList.toggle('show');
  });

  // Close shortcuts when clicking outside
  document.addEventListener('click', function(event) {
    const shortcuts = document.getElementById('shortcuts');
    const helpBtn = document.getElementById('helpBtn');
    
    if (!shortcuts.contains(event.target) && !helpBtn.contains(event.target)) {
      shortcuts.classList.remove('show');
    }
  });

  /* =========================
     INIT
     ========================= */
  // initial UI polish
  setTimeout(()=>document.body.style.opacity = 1, 100);
  </script>
</body>
</html>
